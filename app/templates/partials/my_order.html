<div class="bg-white rounded-lg shadow-sm p-4">
    <h2 class="font-semibold text-gray-800 mb-3 flex items-center gap-2">
        我的訂單
        {% if order and order.items %}
        <span class="text-sm font-normal text-orange-600 font-medium">${{ order.total_amount }}</span>
        {% endif %}
        
        <!-- 狀態標籤 -->
        {% if order %}
        {% if order.status.value == 'submitted' %}
        <span class="text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded">已結單</span>
        {% elif order.status.value == 'editing' %}
        <span class="text-xs bg-amber-100 text-amber-700 px-2 py-0.5 rounded">修改中</span>
        {% endif %}
        {% endif %}
    </h2>
    
    {% if order and order.items %}
    <!-- 品項列表 -->
    <div class="space-y-2 mb-4">
        {% for item in order.items %}
        <div class="flex items-center gap-2 py-2 border-b last:border-b-0" data-item-id="{{ item.id }}">
            <div class="flex-1 min-w-0">
                <div class="font-medium text-gray-800 truncate">{{ item.item_name }}{% if item.size %}({{ item.size }}){% endif %}</div>
                <div class="text-sm text-gray-500">
                    {% if item.sugar or item.ice %}
                    {{ item.sugar }}{% if item.sugar and item.ice %}/{% endif %}{{ item.ice }}
                    {% endif %}
                    {% for opt in item.selected_options %}
                    <span class="text-xs bg-gray-100 px-1 rounded ml-1">{{ opt.option_name }}</span>
                    {% endfor %}
                </div>
                {% if item.note %}
                <div class="text-xs text-amber-600">{{ item.note }}</div>
                {% endif %}
            </div>
            
            {% if is_open and order.status.value != 'submitted' %}
            <!-- 數量調整 -->
            <div class="flex items-center gap-1">
                <button hx-put="/orders/items/{{ item.id }}"
                        hx-vals='{"quantity": {{ item.quantity - 1 }}}'
                        hx-target="#cart-content"
                        hx-swap="innerHTML"
                        @htmx:after-request="$dispatch('orderUpdated')"
                        class="w-6 h-6 rounded bg-gray-100 hover:bg-gray-200 text-xs">−</button>
                <span class="w-5 text-center text-sm">{{ item.quantity }}</span>
                <button hx-put="/orders/items/{{ item.id }}"
                        hx-vals='{"quantity": {{ item.quantity + 1 }}}'
                        hx-target="#cart-content"
                        hx-swap="innerHTML"
                        @htmx:after-request="$dispatch('orderUpdated')"
                        class="w-6 h-6 rounded bg-gray-100 hover:bg-gray-200 text-xs">+</button>
            </div>
            
            <div class="text-orange-600 font-medium text-sm w-12 text-right">${{ item.subtotal }}</div>
            
            <button hx-delete="/orders/items/{{ item.id }}"
                    hx-target="#cart-content"
                    hx-swap="innerHTML"
                    hx-confirm="確定要刪除？"
                    @htmx:after-request="$dispatch('orderUpdated')"
                    class="text-red-400 hover:text-red-600 text-sm">✕</button>
            {% else %}
            <span class="text-gray-500 text-sm">x{{ item.quantity }}</span>
            <div class="text-orange-600 font-medium text-sm">${{ item.subtotal }}</div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
    
    <!-- 操作按鈕 -->
    {% if is_open %}
    <div class="flex gap-2">
        {% if order.status.value == 'draft' or order.status.value == 'editing' %}
        <!-- 未結單/修改中 -->
        <button hx-post="/groups/{{ group.id }}/orders/submit"
                hx-target="#cart-content"
                hx-swap="innerHTML"
                @htmx:after-request="$dispatch('orderUpdated'); location.reload();"
                class="flex-1 py-2.5 rounded-lg bg-orange-500 hover:bg-orange-600 text-white font-medium">
            確定結單
        </button>
        {% if order.status.value == 'editing' %}
        <button hx-post="/groups/{{ group.id }}/orders/cancel"
                hx-target="#cart-content"
                hx-swap="innerHTML"
                @htmx:after-request="$dispatch('orderUpdated'); location.reload();"
                class="py-2.5 px-4 rounded-lg border hover:bg-gray-50">
            取消
        </button>
        {% endif %}
        {% else %}
        <!-- 已結單 -->
        <button hx-post="/groups/{{ group.id }}/orders/edit"
                hx-target="#cart-content"
                hx-swap="innerHTML"
                @htmx:after-request="$dispatch('orderUpdated'); location.reload();"
                class="flex-1 py-2.5 rounded-lg border hover:bg-gray-50">
            修改訂單
        </button>
        {% endif %}
        
        <button hx-delete="/groups/{{ group.id }}/orders"
                hx-target="#cart-content"
                hx-swap="innerHTML"
                hx-confirm="確定要刪除整張訂單嗎？"
                @htmx:after-request="$dispatch('orderUpdated'); location.reload();"
                class="py-2.5 px-3 rounded-lg text-red-500 border border-red-200 hover:bg-red-50">
            刪除
        </button>
    </div>
    {% endif %}
    
    {% else %}
    <!-- 空訂單 -->
    <div class="text-center py-8 text-gray-400">
        <p>購物車是空的</p>
        <p class="text-sm">從菜單選擇品項加入</p>
    </div>
    {% endif %}
</div>
