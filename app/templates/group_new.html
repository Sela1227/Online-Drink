{% extends "base.html" %}

{% block title %}é–‹æ–°åœ˜ - SELA å¿«é»ä¾†é»é¤{% endblock %}

{% block content %}
<div class="space-y-4">
    <!-- å¿«é€Ÿé–‹åœ˜æ¨¡æ¿ -->
    {% if my_templates %}
    <div class="bg-white rounded-lg shadow-sm p-4">
        <div class="flex items-center justify-between mb-3">
            <h2 class="font-semibold text-gray-800">âš¡ å¿«é€Ÿé–‹åœ˜</h2>
            <a href="/templates" class="text-sm text-orange-500 hover:text-orange-600">ç®¡ç†æ¨¡æ¿</a>
        </div>
        <div class="grid grid-cols-2 gap-2">
            {% for tpl in my_templates %}
            <form action="/templates/{{ tpl.id }}/use" method="post">
                <button type="submit" 
                        class="w-full p-3 text-left border rounded-lg hover:border-orange-300 hover:bg-orange-50 transition">
                    <div class="flex items-center gap-2">
                        {% if tpl.store.logo_url %}
                        <img src="{{ tpl.store.logo_url }}" class="w-8 h-8 rounded object-contain">
                        {% else %}
                        <span class="text-lg">
                            {% if tpl.store.category.value == 'drink' %}ğŸ§‹
                            {% elif tpl.store.category.value == 'meal' %}ğŸ±
                            {% else %}ğŸ›’{% endif %}
                        </span>
                        {% endif %}
                        <div class="min-w-0">
                            <div class="font-medium text-gray-800 text-sm truncate">{{ tpl.name }}</div>
                            <div class="text-xs text-gray-500 truncate">{{ tpl.store.name }}</div>
                        </div>
                    </div>
                </button>
            </form>
            {% endfor %}
        </div>
    </div>
    {% endif %}

<div class="bg-white rounded-lg shadow-sm p-4">
    <h1 class="text-xl font-bold text-gray-800 mb-4">
        {% if copy_from %}è¤‡è£½é–‹åœ˜{% else %}é–‹æ–°åœ˜{% endif %}
    </h1>
    
    <form action="/groups" method="post" class="space-y-4" x-data="newGroupForm()">
        <!-- åˆ†é¡é¸æ“‡ -->
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">é¸æ“‡é¡å‹</label>
            <div class="grid grid-cols-3 gap-2">
                <button type="button" @click="selectCategory('drink')"
                        :class="selectedCategory === 'drink' ? 'bg-amber-100 border-amber-400 text-amber-700' : 'bg-gray-50 border-gray-200 text-gray-600 hover:bg-gray-100'"
                        class="p-3 rounded-lg border-2 text-center transition">
                    <div class="text-2xl mb-1">ğŸ§‹</div>
                    <div class="text-sm font-medium">é£²æ–™åº—</div>
                </button>
                <button type="button" @click="selectCategory('meal')"
                        :class="selectedCategory === 'meal' ? 'bg-green-100 border-green-400 text-green-700' : 'bg-gray-50 border-gray-200 text-gray-600 hover:bg-gray-100'"
                        class="p-3 rounded-lg border-2 text-center transition">
                    <div class="text-2xl mb-1">ğŸ±</div>
                    <div class="text-sm font-medium">é¤å»³</div>
                </button>
                <button type="button" @click="selectCategory('group_buy')"
                        :class="selectedCategory === 'group_buy' ? 'bg-blue-100 border-blue-400 text-blue-700' : 'bg-gray-50 border-gray-200 text-gray-600 hover:bg-gray-100'"
                        class="p-3 rounded-lg border-2 text-center transition">
                    <div class="text-2xl mb-1">ğŸ›’</div>
                    <div class="text-sm font-medium">åœ˜è³¼</div>
                </button>
            </div>
        </div>
        
        <!-- åº—å®¶é¸æ“‡ -->
        <div x-show="selectedCategory" x-cloak>
            <label class="block text-sm font-medium text-gray-700 mb-2">é¸æ“‡åº—å®¶</label>
            <select name="store_id" x-model="storeId" @change="onStoreChange()" required
                    class="w-full border rounded-lg px-3 py-2">
                <option value="">è«‹é¸æ“‡...</option>
                <template x-for="store in filteredStores" :key="store.id">
                    <option :value="store.id" 
                            :data-category="store.category"
                            :data-branches="JSON.stringify(store.branches)"
                            :data-has-toppings="store.has_toppings"
                            x-text="store.name">
                    </option>
                </template>
            </select>
            <p class="text-xs text-gray-400 mt-1" x-show="filteredStores.length === 0">
                æ­¤é¡å‹å°šç„¡åº—å®¶ï¼Œè«‹å…ˆåˆ°å¾Œå°æ–°å¢
            </p>
        </div>
        
        <!-- åˆ†åº—é¸æ“‡ -->
        <div x-show="branches.length > 0" x-cloak>
            <label class="block text-sm font-medium text-gray-700 mb-2">é¸æ“‡åˆ†åº—</label>
            <select name="branch_id" x-model="branchId" class="w-full border rounded-lg px-3 py-2">
                <option value="">ä¸æŒ‡å®šåˆ†åº—</option>
                <template x-for="branch in branches" :key="branch.id">
                    <option :value="branch.id" x-text="branch.name + (branch.phone ? ' (' + branch.phone + ')' : '')"></option>
                </template>
            </select>
        </div>
        
        <!-- åœ˜å -->
        <div x-show="storeId" x-cloak>
            <label class="block text-sm font-medium text-gray-700 mb-2">åœ˜å</label>
            <input type="text" name="name" required placeholder="ä¾‹ï¼šä¸‹åˆèŒ¶åœ˜"
                   class="w-full border rounded-lg px-3 py-2"
                   value="{% if copy_from %}{{ copy_from.name }}{% endif %}">
        </div>
        
        <!-- å‚™è¨» -->
        <div x-show="storeId" x-cloak>
            <label class="block text-sm font-medium text-gray-700 mb-2">å‚™è¨»ï¼ˆé¸å¡«ï¼‰</label>
            <textarea name="note" rows="2" placeholder="ä¾‹ï¼šå–é¤åœ°é»åœ¨ 3F èŒ¶æ°´é–“"
                      class="w-full border rounded-lg px-3 py-2 text-sm">{% if copy_from and copy_from.note %}{{ copy_from.note }}{% endif %}</textarea>
        </div>
        
        <!-- å¤–é€è²» -->
        <div x-show="storeId" x-cloak>
            <label class="block text-sm font-medium text-gray-700 mb-2">å¤–é€è²»ï¼ˆé¸å¡«ï¼‰</label>
            <div class="flex items-center gap-2">
                <span class="text-gray-500">$</span>
                <input type="number" name="delivery_fee" min="0" step="1" placeholder="0"
                       class="w-32 border rounded-lg px-3 py-2"
                       value="{% if copy_from and copy_from.delivery_fee %}{{ copy_from.delivery_fee|int }}{% endif %}">
                <span class="text-sm text-gray-500">æœƒè‡ªå‹•å¹³å‡åˆ†æ”¤çµ¦æ‰€æœ‰äºº</span>
            </div>
        </div>
        
        <!-- å¯è¦‹ç¯„åœ -->
        <div x-show="storeId" x-cloak x-data="{ isPublic: true }">
            <label class="block text-sm font-medium text-gray-700 mb-2">å¯è¦‹ç¯„åœ</label>
            <div class="space-y-2">
                <label class="flex items-center gap-2">
                    <input type="radio" name="visibility" value="public" checked
                           @change="isPublic = true">
                    <span class="text-sm">ğŸŒ å…¬é–‹ï¼ˆæ‰€æœ‰äººå¯è¦‹ï¼‰</span>
                </label>
                <label class="flex items-center gap-2">
                    <input type="radio" name="visibility" value="departments"
                           @change="isPublic = false">
                    <span class="text-sm">ğŸ‘¥ é™å®šéƒ¨é–€</span>
                </label>
            </div>
            
            <!-- éƒ¨é–€é¸æ“‡ -->
            <div x-show="!isPublic" x-cloak class="mt-3 p-3 bg-gray-50 rounded-lg">
                {% if departments %}
                <div class="space-y-2">
                    {% for dept in departments %}
                    <label class="flex items-center gap-2">
                        <input type="checkbox" name="department_ids" value="{{ dept.id }}">
                        <span class="text-sm">{{ dept.name }}</span>
                        <span class="text-xs text-gray-400">({{ dept.member_count }}äºº)</span>
                    </label>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-sm text-gray-500">å°šæœªå»ºç«‹éƒ¨é–€ï¼Œè«‹è‡³å¾Œå°å»ºç«‹</p>
                {% endif %}
            </div>
        </div>
        
        <!-- æˆªæ­¢æ™‚é–“ -->
        <div x-show="storeId" x-cloak>
            <label class="block text-sm font-medium text-gray-700 mb-2">æˆªæ­¢æ™‚é–“</label>
            <div class="flex flex-wrap gap-2 mb-2">
                <button type="button" @click="setDeadline('30m')"
                        class="text-sm px-3 py-1 rounded border hover:bg-gray-50">
                    30åˆ†é˜å¾Œ
                </button>
                <button type="button" @click="setDeadline('1h')"
                        class="text-sm px-3 py-1 rounded border hover:bg-gray-50">
                    1å°æ™‚å¾Œ
                </button>
                <button type="button" @click="setDeadline('12:00')"
                        class="text-sm px-3 py-1 rounded border hover:bg-gray-50">
                    ä»Šå¤© 12:00
                </button>
                <button type="button" @click="setDeadline('17:00')"
                        class="text-sm px-3 py-1 rounded border hover:bg-gray-50">
                    ä»Šå¤© 17:00
                </button>
            </div>
            <input type="datetime-local" name="deadline" x-ref="deadline" required
                   class="w-full border rounded-lg px-3 py-2">
        </div>
        
        <!-- é£²æ–™åœ˜è¨­å®š -->
        <div x-show="selectedCategory === 'drink' && storeId" x-cloak class="space-y-4 p-4 bg-amber-50 rounded-lg">
            <h3 class="font-medium text-gray-700">é£²æ–™åœ˜è¨­å®š</h3>
            
            <!-- é è¨­ç”œåº¦ -->
            <div>
                <label class="block text-sm text-gray-600 mb-1">é è¨­ç”œåº¦</label>
                <select name="default_sugar" class="w-full border rounded px-3 py-2">
                    <option value="">ä¸æŒ‡å®š</option>
                    <option value="æ­£å¸¸ç³–">æ­£å¸¸ç³–</option>
                    <option value="å°‘ç³–">å°‘ç³–</option>
                    <option value="åŠç³–">åŠç³–</option>
                    <option value="å¾®ç³–">å¾®ç³–</option>
                    <option value="ç„¡ç³–">ç„¡ç³–</option>
                </select>
            </div>
            
            <!-- é è¨­å†°å¡Š -->
            <div>
                <label class="block text-sm text-gray-600 mb-1">é è¨­å†°å¡Š</label>
                <select name="default_ice" class="w-full border rounded px-3 py-2">
                    <option value="">ä¸æŒ‡å®š</option>
                    <option value="æ­£å¸¸å†°">æ­£å¸¸å†°</option>
                    <option value="å°‘å†°">å°‘å†°</option>
                    <option value="å¾®å†°">å¾®å†°</option>
                    <option value="å»å†°">å»å†°</option>
                    <option value="ç†±">ç†±</option>
                </select>
            </div>
            
            <!-- é–å®šé¸é … -->
            <div class="flex gap-4">
                <label class="flex items-center gap-2 cursor-pointer">
                    <input type="checkbox" name="lock_sugar" value="true">
                    <span class="text-sm text-gray-600">é–å®šç”œåº¦</span>
                </label>
                <label class="flex items-center gap-2 cursor-pointer">
                    <input type="checkbox" name="lock_ice" value="true">
                    <span class="text-sm text-gray-600">é–å®šå†°å¡Š</span>
                </label>
            </div>
        </div>
        
        <!-- è¶£å‘³åŠŸèƒ½è¨­å®š -->
        <div x-show="storeId" x-cloak class="p-4 bg-purple-50 rounded-lg" x-data="{ showFunOptions: false }">
            <button type="button" @click="showFunOptions = !showFunOptions"
                    class="flex items-center justify-between w-full text-left">
                <h3 class="font-medium text-purple-700">ğŸ‰ è¶£å‘³åŠŸèƒ½ï¼ˆé¸ç”¨ï¼‰</h3>
                <span class="text-purple-500" x-text="showFunOptions ? 'â–²' : 'â–¼'"></span>
            </button>
            
            <div x-show="showFunOptions" x-cloak class="mt-4 space-y-4">
                <!-- ç›²é»æ¨¡å¼ -->
                <div class="flex items-start gap-3 p-3 bg-white rounded-lg">
                    <input type="checkbox" name="is_blind_mode" value="true" class="mt-1">
                    <div>
                        <div class="font-medium text-gray-700">ğŸ™ˆ ç›²é»æ¨¡å¼</div>
                        <p class="text-xs text-gray-500">æˆªæ­¢å‰éš±è—å…¶ä»–äººçš„é¸æ“‡ï¼Œæˆªæ­¢å¾Œä¸€èµ·æ­æ›‰</p>
                    </div>
                </div>
                
                <!-- éš¨æ©Ÿå…å–® -->
                <div class="p-3 bg-white rounded-lg" x-data="{ enableLucky: false }">
                    <div class="flex items-start gap-3">
                        <input type="checkbox" name="enable_lucky_draw" value="true" 
                               @change="enableLucky = $event.target.checked" class="mt-1">
                        <div class="flex-1">
                            <div class="font-medium text-gray-700">ğŸŠ éš¨æ©Ÿå…å–®</div>
                            <p class="text-xs text-gray-500">çµå–®æ™‚éš¨æ©ŸæŠ½é¸å¹¸é‹å…’å…å–®</p>
                        </div>
                    </div>
                    <div x-show="enableLucky" x-cloak class="mt-3 flex items-center gap-2 pl-6">
                        <span class="text-sm text-gray-600">å…å–®äººæ•¸</span>
                        <input type="number" name="lucky_draw_count" value="1" min="1" max="5"
                               class="w-16 border rounded px-2 py-1 text-center">
                        <span class="text-sm text-gray-600">äºº</span>
                    </div>
                </div>
                
                <!-- æ¹Šåœ˜åˆ¶ -->
                <div class="p-3 bg-white rounded-lg" x-data="{ enableMinMembers: false }">
                    <div class="flex items-start gap-3">
                        <input type="checkbox" 
                               @change="enableMinMembers = $event.target.checked" class="mt-1">
                        <div class="flex-1">
                            <div class="font-medium text-gray-700">ğŸ¯ æ¹Šåœ˜åˆ¶</div>
                            <p class="text-xs text-gray-500">è¨­å®šæœ€å°‘æˆåœ˜äººæ•¸</p>
                        </div>
                    </div>
                    <div x-show="enableMinMembers" x-cloak class="mt-3 space-y-2 pl-6">
                        <div class="flex items-center gap-2">
                            <span class="text-sm text-gray-600">æœ€å°‘</span>
                            <input type="number" name="min_members" value="5" min="2" max="50"
                                   class="w-16 border rounded px-2 py-1 text-center">
                            <span class="text-sm text-gray-600">äººæˆåœ˜</span>
                        </div>
                        <label class="flex items-center gap-2 text-sm text-gray-600">
                            <input type="checkbox" name="auto_extend" value="true">
                            <span>æœªé”äººæ•¸è‡ªå‹•å»¶é•· 30 åˆ†é˜</span>
                        </label>
                    </div>
                </div>
                
                <!-- è‡ªå‹•å‚¬å–® -->
                <div class="p-3 bg-white rounded-lg" x-data="{ enableRemind: false }">
                    <div class="flex items-start gap-3">
                        <input type="checkbox" 
                               @change="enableRemind = $event.target.checked" class="mt-1">
                        <div class="flex-1">
                            <div class="font-medium text-gray-700">â° è‡ªå‹•å‚¬å–®</div>
                            <p class="text-xs text-gray-500">æˆªæ­¢å‰è‡ªå‹•æé†’å°šæœªçµå–®çš„äºº</p>
                        </div>
                    </div>
                    <div x-show="enableRemind" x-cloak class="mt-3 flex items-center gap-2 pl-6">
                        <span class="text-sm text-gray-600">æˆªæ­¢å‰</span>
                        <select name="auto_remind_minutes" class="border rounded px-2 py-1 text-sm">
                            <option value="10">10 åˆ†é˜</option>
                            <option value="15" selected>15 åˆ†é˜</option>
                            <option value="30">30 åˆ†é˜</option>
                        </select>
                        <span class="text-sm text-gray-600">æé†’</span>
                    </div>
                </div>
                
                <!-- æˆ‘è«‹å®¢ -->
                <div class="p-3 bg-white rounded-lg">
                    <label class="flex items-start gap-3 cursor-pointer">
                        <input type="checkbox" name="i_treat" value="true" class="mt-1">
                        <div class="flex-1">
                            <div class="font-medium text-red-600">ğŸ’ é€™å–®æˆ‘è«‹å®¢</div>
                            <p class="text-xs text-gray-500">æœ¬åœ˜å°‡ç”±ä½ è²·å–®</p>
                        </div>
                    </label>
                </div>
            </div>
        </div>
        
        <!-- é€å‡ºæŒ‰éˆ• -->
        <div class="flex gap-2 pt-4" x-show="storeId" x-cloak>
            <a href="/home" class="flex-1 py-3 text-center rounded-lg border hover:bg-gray-50">
                å–æ¶ˆ
            </a>
            <button type="submit" class="flex-1 py-3 rounded-lg bg-orange-500 hover:bg-orange-600 text-white font-medium">
                é–‹åœ˜
            </button>
        </div>
    </form>
</div>
</div>

<script>
function newGroupForm() {
    // å¾å¾Œç«¯å‚³å…¥çš„åº—å®¶è³‡æ–™
    const allStores = [
        {% for store in stores %}
        {
            id: {{ store.id }},
            name: "{{ store.name }}",
            category: "{{ store.category.value if store.category else 'meal' }}",
            branches: {{ store.branches | tojson if store.branches else "[]" }},
            has_toppings: {{ 'true' if store.toppings else 'false' }}
        }{% if not loop.last %},{% endif %}
        {% endfor %}
    ];
    
    return {
        selectedCategory: '{% if copy_from %}{{ copy_from.category.value }}{% endif %}',
        storeId: '{% if copy_from %}{{ copy_from.store_id }}{% endif %}',
        branchId: '',
        branches: [],
        
        get filteredStores() {
            return allStores.filter(s => s.category === this.selectedCategory);
        },
        
        init() {
            if (this.storeId) {
                this.onStoreChange();
            }
        },
        
        selectCategory(category) {
            this.selectedCategory = category;
            this.storeId = '';
            this.branches = [];
            this.branchId = '';
        },
        
        onStoreChange() {
            const store = allStores.find(s => s.id == this.storeId);
            if (store) {
                this.branches = store.branches || [];
            } else {
                this.branches = [];
            }
            this.branchId = '';
        },
        
        setDeadline(preset) {
            const now = new Date();
            let target;
            
            if (preset === '30m') {
                target = new Date(now.getTime() + 30 * 60000);
            } else if (preset === '1h') {
                target = new Date(now.getTime() + 60 * 60000);
            } else if (preset === '12:00') {
                target = new Date(now);
                target.setHours(12, 0, 0, 0);
                if (target <= now) target.setDate(target.getDate() + 1);
            } else if (preset === '17:00') {
                target = new Date(now);
                target.setHours(17, 0, 0, 0);
                if (target <= now) target.setDate(target.getDate() + 1);
            }
            
            if (target) {
                const y = target.getFullYear();
                const m = String(target.getMonth() + 1).padStart(2, '0');
                const d = String(target.getDate()).padStart(2, '0');
                const h = String(target.getHours()).padStart(2, '0');
                const min = String(target.getMinutes()).padStart(2, '0');
                this.$refs.deadline.value = `${y}-${m}-${d}T${h}:${min}`;
            }
        }
    }
}
</script>
{% endblock %}
