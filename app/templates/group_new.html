{% extends "base.html" %}

{% block title %}開新團 - SELA 快點來點餐{% endblock %}

{% block content %}
<div class="bg-white rounded-lg shadow-sm p-4" x-data="newGroup()">
    <h1 class="text-xl font-bold text-gray-800 mb-4">
        {% if copy_from %}複製開團{% else %}開新團{% endif %}
    </h1>
    
    <form action="/groups" method="post" class="space-y-4">
        <!-- 店家選擇 -->
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">選擇店家</label>
            <select name="store_id" required x-model="storeId" @change="onStoreChange()"
                    class="w-full border rounded-lg px-3 py-2">
                <option value="">請選擇...</option>
                {% for store in stores %}
                <option value="{{ store.id }}" 
                        data-category="{{ store.category.value }}"
                        {% if copy_from and copy_from.store_id == store.id %}selected{% endif %}>
                    {{ store.name }} ({{ '飲料' if store.category.value == 'drink' else '餐點' }})
                </option>
                {% endfor %}
            </select>
        </div>
        
        <!-- 團名 -->
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">團名</label>
            <input type="text" name="name" required placeholder="例：下午茶團"
                   class="w-full border rounded-lg px-3 py-2"
                   value="{% if copy_from %}{{ copy_from.name }}{% endif %}">
        </div>
        
        <!-- 截止時間 -->
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">截止時間</label>
            <div class="flex flex-wrap gap-2 mb-2">
                {% for preset in ['30分鐘後', '1小時後', '今天 12:00', '今天 17:00', '明天 12:00'] %}
                <button type="button" @click="setDeadline('{{ preset }}')"
                        class="text-sm px-3 py-1 rounded border hover:bg-gray-50">
                    {{ preset }}
                </button>
                {% endfor %}
            </div>
            <input type="datetime-local" name="deadline" required x-model="deadline"
                   class="w-full border rounded-lg px-3 py-2">
        </div>
        
        <!-- 飲料團設定 -->
        <div x-show="category === 'drink'" x-cloak class="space-y-4 p-4 bg-gray-50 rounded-lg">
            <h3 class="font-medium text-gray-700">飲料團設定</h3>
            
            <!-- 預設甜度 -->
            <div>
                <label class="block text-sm text-gray-600 mb-1">預設甜度</label>
                <select name="default_sugar" class="w-full border rounded px-3 py-2">
                    <option value="">不指定</option>
                    <option value="正常糖" {% if copy_from and copy_from.default_sugar == '正常糖' %}selected{% endif %}>正常糖</option>
                    <option value="少糖" {% if copy_from and copy_from.default_sugar == '少糖' %}selected{% endif %}>少糖</option>
                    <option value="半糖" {% if copy_from and copy_from.default_sugar == '半糖' %}selected{% endif %}>半糖</option>
                    <option value="微糖" {% if copy_from and copy_from.default_sugar == '微糖' %}selected{% endif %}>微糖</option>
                    <option value="無糖" {% if copy_from and copy_from.default_sugar == '無糖' %}selected{% endif %}>無糖</option>
                </select>
            </div>
            
            <!-- 預設冰塊 -->
            <div>
                <label class="block text-sm text-gray-600 mb-1">預設冰塊</label>
                <select name="default_ice" class="w-full border rounded px-3 py-2">
                    <option value="">不指定</option>
                    <option value="正常冰" {% if copy_from and copy_from.default_ice == '正常冰' %}selected{% endif %}>正常冰</option>
                    <option value="少冰" {% if copy_from and copy_from.default_ice == '少冰' %}selected{% endif %}>少冰</option>
                    <option value="微冰" {% if copy_from and copy_from.default_ice == '微冰' %}selected{% endif %}>微冰</option>
                    <option value="去冰" {% if copy_from and copy_from.default_ice == '去冰' %}selected{% endif %}>去冰</option>
                    <option value="熱" {% if copy_from and copy_from.default_ice == '熱' %}selected{% endif %}>熱</option>
                </select>
            </div>
            
            <!-- 鎖定選項 -->
            <div class="flex gap-4">
                <label class="flex items-center gap-2 cursor-pointer">
                    <input type="checkbox" name="lock_sugar" value="true"
                           {% if copy_from and copy_from.lock_sugar %}checked{% endif %}>
                    <span class="text-sm text-gray-600">鎖定甜度</span>
                </label>
                <label class="flex items-center gap-2 cursor-pointer">
                    <input type="checkbox" name="lock_ice" value="true"
                           {% if copy_from and copy_from.lock_ice %}checked{% endif %}>
                    <span class="text-sm text-gray-600">鎖定冰塊</span>
                </label>
            </div>
        </div>
        
        <!-- 送出按鈕 -->
        <div class="flex gap-2 pt-4">
            <a href="/home" class="flex-1 py-3 text-center rounded-lg border hover:bg-gray-50">
                取消
            </a>
            <button type="submit" class="flex-1 py-3 rounded-lg bg-orange-500 hover:bg-orange-600 text-white font-medium">
                開團！
            </button>
        </div>
    </form>
</div>

<script>
function newGroup() {
    return {
        storeId: '{% if copy_from %}{{ copy_from.store_id }}{% endif %}',
        category: '{% if copy_from %}{{ copy_from.category.value }}{% endif %}',
        deadline: '',
        
        onStoreChange() {
            const select = document.querySelector('select[name="store_id"]');
            const option = select.options[select.selectedIndex];
            this.category = option.dataset.category || '';
        },
        
        setDeadline(preset) {
            const now = new Date();
            let target;
            
            if (preset.includes('分鐘後')) {
                const minutes = parseInt(preset);
                target = new Date(now.getTime() + minutes * 60000);
            } else if (preset.includes('小時後')) {
                const hours = parseInt(preset);
                target = new Date(now.getTime() + hours * 3600000);
            } else if (preset.startsWith('今天')) {
                const time = preset.replace('今天 ', '').split(':');
                target = new Date(now);
                target.setHours(parseInt(time[0]), parseInt(time[1]), 0, 0);
            } else if (preset.startsWith('明天')) {
                const time = preset.replace('明天 ', '').split(':');
                target = new Date(now);
                target.setDate(target.getDate() + 1);
                target.setHours(parseInt(time[0]), parseInt(time[1]), 0, 0);
            }
            
            if (target) {
                // 轉換成 datetime-local 格式
                const year = target.getFullYear();
                const month = String(target.getMonth() + 1).padStart(2, '0');
                const day = String(target.getDate()).padStart(2, '0');
                const hours = String(target.getHours()).padStart(2, '0');
                const minutes = String(target.getMinutes()).padStart(2, '0');
                this.deadline = `${year}-${month}-${day}T${hours}:${minutes}`;
            }
        }
    }
}
</script>
{% endblock %}
