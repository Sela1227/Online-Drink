{% extends "base.html" %}

{% block title %}ç™¼èµ·æŠ•ç¥¨ - SELA å¿«é»ä¾†é»é¤{% endblock %}

{% block content %}
<div class="bg-white rounded-lg shadow-sm p-4">
    <div class="flex items-center justify-between mb-4">
        <h1 class="text-xl font-bold text-gray-800">ğŸ—³ï¸ ç™¼èµ·æŠ•ç¥¨</h1>
        <a href="/votes" class="text-sm text-gray-500 hover:text-gray-700">è¿”å›æŠ•ç¥¨åˆ—è¡¨ â†’</a>
    </div>
    
    <form action="/votes" method="post" class="space-y-4" x-data="newVoteForm()">
        <!-- æŠ•ç¥¨æ¨™é¡Œ -->
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">æŠ•ç¥¨æ¨™é¡Œ</label>
            <input type="text" name="title" required
                   placeholder="ä¾‹ï¼šä»Šå¤©åˆé¤åƒä»€éº¼ï¼Ÿ"
                   class="w-full border rounded-lg px-3 py-2">
        </div>
        
        <!-- èªªæ˜ -->
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">èªªæ˜ï¼ˆé¸å¡«ï¼‰</label>
            <textarea name="description" rows="2" placeholder="è£œå……èªªæ˜..."
                      class="w-full border rounded-lg px-3 py-2 text-sm"></textarea>
        </div>
        
        <!-- æˆªæ­¢æ™‚é–“ -->
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">æŠ•ç¥¨æˆªæ­¢æ™‚é–“</label>
            <div class="flex flex-wrap gap-2 mb-2">
                <button type="button" @click="setDeadline('30m')"
                        class="text-sm px-3 py-1 rounded border hover:bg-gray-50">
                    30åˆ†é˜å¾Œ
                </button>
                <button type="button" @click="setDeadline('1h')"
                        class="text-sm px-3 py-1 rounded border hover:bg-gray-50">
                    1å°æ™‚å¾Œ
                </button>
                <button type="button" @click="setDeadline('11:30')"
                        class="text-sm px-3 py-1 rounded border hover:bg-gray-50">
                    ä»Šå¤© 11:30
                </button>
            </div>
            <input type="datetime-local" name="deadline" x-ref="deadline" required
                   class="w-full border rounded-lg px-3 py-2">
        </div>
        
        <!-- æŠ•ç¥¨é¸é … -->
        <div>
            <label class="flex items-center gap-2 cursor-pointer">
                <input type="checkbox" name="is_multiple" value="true">
                <span class="text-sm text-gray-600">å…è¨±å¤šé¸</span>
            </label>
        </div>
        
        <!-- å¯è¦‹æ€§è¨­å®š -->
        <div x-data="{ isPublic: true }">
            <label class="block text-sm font-medium text-gray-700 mb-2">å¯è¦‹ç¯„åœ</label>
            <div class="space-y-2">
                <label class="flex items-center gap-2 cursor-pointer">
                    <input type="radio" name="visibility" value="public" checked
                           @change="isPublic = true">
                    <span class="text-sm text-gray-600">ğŸŒ å…¨é«”å¯è¦‹</span>
                </label>
                <label class="flex items-center gap-2 cursor-pointer">
                    <input type="radio" name="visibility" value="department"
                           @change="isPublic = false">
                    <span class="text-sm text-gray-600">ğŸ‘¥ é™å®šéƒ¨é–€</span>
                </label>
            </div>
            
            <!-- éƒ¨é–€é¸æ“‡ -->
            <div x-show="!isPublic" x-cloak class="mt-3 p-3 bg-gray-50 rounded-lg">
                <div class="text-xs text-gray-500 mb-2">é¸æ“‡å¯è¦‹çš„éƒ¨é–€ï¼ˆå¯å¤šé¸ï¼‰</div>
                <div class="space-y-1 max-h-32 overflow-y-auto">
                    {% for dept in departments %}
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" name="department_ids" value="{{ dept.id }}">
                        <span class="text-sm">{{ dept.name }}</span>
                    </label>
                    {% endfor %}
                </div>
            </div>
        </div>
        
        <!-- é¸æ“‡åº—å®¶ -->
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">é¸æ“‡åº—å®¶ï¼ˆè‡³å°‘2å€‹ï¼‰</label>
            
            <!-- åˆ†é¡ç¯©é¸ -->
            <div class="flex gap-2 mb-3">
                <button type="button" @click="filterCategory = ''"
                        :class="filterCategory === '' ? 'bg-orange-100 text-orange-700 border-orange-300' : 'bg-gray-50 border-gray-200'"
                        class="px-3 py-1 rounded border text-sm">
                    å…¨éƒ¨
                </button>
                <button type="button" @click="filterCategory = 'drink'"
                        :class="filterCategory === 'drink' ? 'bg-amber-100 text-amber-700 border-amber-300' : 'bg-gray-50 border-gray-200'"
                        class="px-3 py-1 rounded border text-sm">
                    ğŸ§‹ é£²æ–™
                </button>
                <button type="button" @click="filterCategory = 'meal'"
                        :class="filterCategory === 'meal' ? 'bg-green-100 text-green-700 border-green-300' : 'bg-gray-50 border-gray-200'"
                        class="px-3 py-1 rounded border text-sm">
                    ğŸ± é¤å»³
                </button>
                <button type="button" @click="filterCategory = 'group_buy'"
                        :class="filterCategory === 'group_buy' ? 'bg-blue-100 text-blue-700 border-blue-300' : 'bg-gray-50 border-gray-200'"
                        class="px-3 py-1 rounded border text-sm">
                    ğŸ›’ åœ˜è³¼
                </button>
            </div>
            
            <div class="grid grid-cols-2 gap-2 max-h-60 overflow-y-auto p-2 border rounded-lg">
                {% for store in stores %}
                <label class="flex items-center gap-2 p-2 rounded hover:bg-gray-50 cursor-pointer"
                       x-show="filterCategory === '' || filterCategory === '{{ store.category.value }}'">
                    <input type="checkbox" name="store_ids" value="{{ store.id }}"
                           @change="updateSelectedCount()">
                    <span class="text-sm">
                        {% if store.category.value == 'drink' %}ğŸ§‹
                        {% elif store.category.value == 'meal' %}ğŸ±
                        {% else %}ğŸ›’{% endif %}
                        {{ store.name }}
                    </span>
                </label>
                {% endfor %}
            </div>
            <div class="text-xs text-gray-500 mt-1">
                å·²é¸æ“‡ <span x-text="selectedCount">0</span> å€‹åº—å®¶
            </div>
        </div>
        
        <!-- é€å‡ºæŒ‰éˆ• -->
        <div class="flex gap-2 pt-4">
            <a href="/votes" class="flex-1 py-3 text-center rounded-lg border hover:bg-gray-50">
                å–æ¶ˆ
            </a>
            <button type="submit" 
                    :disabled="selectedCount < 2"
                    :class="selectedCount < 2 ? 'bg-gray-300 cursor-not-allowed' : 'bg-orange-500 hover:bg-orange-600'"
                    class="flex-1 py-3 rounded-lg text-white font-medium">
                ç™¼èµ·æŠ•ç¥¨
            </button>
        </div>
    </form>
</div>

<script>
function newVoteForm() {
    return {
        filterCategory: '',
        selectedCount: 0,
        
        updateSelectedCount() {
            this.selectedCount = document.querySelectorAll('input[name="store_ids"]:checked').length;
        },
        
        setDeadline(preset) {
            const now = new Date();
            let target;
            
            if (preset === '30m') {
                target = new Date(now.getTime() + 30 * 60000);
            } else if (preset === '1h') {
                target = new Date(now.getTime() + 60 * 60000);
            } else if (preset === '11:30') {
                target = new Date(now);
                target.setHours(11, 30, 0, 0);
                if (target <= now) target.setDate(target.getDate() + 1);
            }
            
            if (target) {
                const y = target.getFullYear();
                const m = String(target.getMonth() + 1).padStart(2, '0');
                const d = String(target.getDate()).padStart(2, '0');
                const h = String(target.getHours()).padStart(2, '0');
                const min = String(target.getMinutes()).padStart(2, '0');
                this.$refs.deadline.value = `${y}-${m}-${d}T${h}:${min}`;
            }
        }
    }
}
</script>
{% endblock %}
