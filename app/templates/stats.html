{% extends "base.html" %}

{% block title %}æ¶ˆè²»çµ±è¨ˆ - SELA å¿«é»ä¾†é»é¤{% endblock %}

{% block content %}
<div class="space-y-4">
    <!-- æ¨™é¡Œåˆ— -->
    <div class="flex items-center justify-between">
        <h1 class="text-xl font-bold text-gray-800">ğŸ“Š æˆ‘çš„æ¶ˆè²»çµ±è¨ˆ</h1>
        <a href="/profile" class="text-sm text-gray-500 hover:text-gray-700">è¿”å›å€‹äººè³‡æ–™ â†’</a>
    </div>
    
    <!-- æ™‚é–“ç¯©é¸ -->
    <div class="bg-white rounded-lg shadow-sm p-4">
        <div class="flex flex-wrap gap-2 mb-3">
            <a href="/stats?period=month" 
               class="px-3 py-1.5 rounded-full text-sm {% if period == 'month' %}bg-orange-500 text-white{% else %}bg-gray-100 text-gray-600 hover:bg-gray-200{% endif %}">
                é€™å€‹æœˆ
            </a>
            <a href="/stats?period=last_month" 
               class="px-3 py-1.5 rounded-full text-sm {% if period == 'last_month' %}bg-orange-500 text-white{% else %}bg-gray-100 text-gray-600 hover:bg-gray-200{% endif %}">
                éå»30å¤©
            </a>
            <a href="/stats?period=3months" 
               class="px-3 py-1.5 rounded-full text-sm {% if period == '3months' %}bg-orange-500 text-white{% else %}bg-gray-100 text-gray-600 hover:bg-gray-200{% endif %}">
                éå»3å€‹æœˆ
            </a>
            <a href="/stats?period=year" 
               class="px-3 py-1.5 rounded-full text-sm {% if period == 'year' %}bg-orange-500 text-white{% else %}bg-gray-100 text-gray-600 hover:bg-gray-200{% endif %}">
                ä»Šå¹´
            </a>
            <a href="/stats?period=all" 
               class="px-3 py-1.5 rounded-full text-sm {% if period == 'all' %}bg-orange-500 text-white{% else %}bg-gray-100 text-gray-600 hover:bg-gray-200{% endif %}">
                å…¨éƒ¨
            </a>
        </div>
        
        <!-- è‡ªè¨‚å€é–“ -->
        <form action="/stats" method="get" class="flex flex-wrap items-center gap-2" x-data="{ showCustom: {{ 'true' if period == 'custom' else 'false' }} }">
            <button type="button" @click="showCustom = !showCustom" 
                    class="px-3 py-1.5 rounded-full text-sm {% if period == 'custom' %}bg-orange-500 text-white{% else %}bg-gray-100 text-gray-600 hover:bg-gray-200{% endif %}">
                ğŸ“… è‡ªè¨‚å€é–“
            </button>
            <div x-show="showCustom" x-cloak class="flex items-center gap-2 flex-wrap">
                <input type="hidden" name="period" value="custom">
                <input type="date" name="start_date" value="{{ start_date }}" 
                       class="border rounded px-2 py-1 text-sm">
                <span class="text-gray-400">~</span>
                <input type="date" name="end_date" value="{{ end_date }}" 
                       class="border rounded px-2 py-1 text-sm">
                <button type="submit" class="px-3 py-1 bg-orange-500 text-white rounded text-sm">æŸ¥è©¢</button>
            </div>
        </form>
        
        <div class="text-xs text-gray-400 mt-2">
            çµ±è¨ˆæœŸé–“ï¼š{{ date_start.strftime('%Y/%m/%d') }} ~ {{ date_end.strftime('%Y/%m/%d') }}
        </div>
    </div>
    
    <!-- ç¸½è¦½ -->
    <div class="bg-gradient-to-br from-orange-500 to-amber-500 rounded-xl shadow-lg p-5 text-white">
        <div class="text-sm opacity-80 mb-1">ç¸½æ¶ˆè²»é‡‘é¡</div>
        <div class="text-4xl font-bold mb-3">${{ "{:,.0f}".format(total_amount) }}</div>
        <div class="grid grid-cols-2 gap-4 text-sm">
            <div>
                <div class="opacity-70">è¨‚å–®æ•¸</div>
                <div class="text-xl font-semibold">{{ total_orders }} ç­†</div>
            </div>
            <div>
                <div class="opacity-70">å¹³å‡æ¯å–®</div>
                <div class="text-xl font-semibold">${{ "{:,.0f}".format(avg_amount) }}</div>
            </div>
        </div>
    </div>
    
    <!-- åˆ†é¡çµ±è¨ˆ -->
    <div class="grid grid-cols-3 gap-3">
        <!-- é£²æ–™ -->
        <div class="bg-amber-50 rounded-lg p-3 border border-amber-200">
            <div class="text-2xl mb-1">ğŸ§‹</div>
            <div class="text-xs text-amber-600 mb-1">é£²æ–™</div>
            <div class="text-lg font-bold text-amber-700">${{ "{:,.0f}".format(category_stats.drink.amount) }}</div>
            <div class="text-xs text-amber-500">{{ category_stats.drink.orders }} ç­†</div>
        </div>
        <!-- é¤é» -->
        <div class="bg-green-50 rounded-lg p-3 border border-green-200">
            <div class="text-2xl mb-1">ğŸ±</div>
            <div class="text-xs text-green-600 mb-1">é¤é»</div>
            <div class="text-lg font-bold text-green-700">${{ "{:,.0f}".format(category_stats.meal.amount) }}</div>
            <div class="text-xs text-green-500">{{ category_stats.meal.orders }} ç­†</div>
        </div>
        <!-- åœ˜è³¼ -->
        <div class="bg-blue-50 rounded-lg p-3 border border-blue-200">
            <div class="text-2xl mb-1">ğŸ›’</div>
            <div class="text-xs text-blue-600 mb-1">åœ˜è³¼</div>
            <div class="text-lg font-bold text-blue-700">${{ "{:,.0f}".format(category_stats.group_buy.amount) }}</div>
            <div class="text-xs text-blue-500">{{ category_stats.group_buy.orders }} ç­†</div>
        </div>
    </div>
    
    <!-- æœˆåº¦è¶¨å‹¢ -->
    <div class="bg-white rounded-lg shadow-sm p-4">
        <h2 class="font-semibold text-gray-800 mb-3">ğŸ“ˆ è¿‘6å€‹æœˆè¶¨å‹¢</h2>
        <div class="flex items-end justify-between gap-2 h-32">
            {% set max_amount = monthly_trend | map(attribute='amount') | max or 1 %}
            {% for month in monthly_trend %}
            <div class="flex-1 flex flex-col items-center">
                <div class="w-full bg-orange-100 rounded-t relative" 
                     style="height: {{ (month.amount / max_amount * 100) | int }}%">
                    {% if month.amount > 0 %}
                    <div class="absolute -top-5 left-1/2 -translate-x-1/2 text-xs text-orange-600 whitespace-nowrap">
                        {{ "{:,.0f}".format(month.amount) }}
                    </div>
                    {% endif %}
                </div>
                <div class="text-xs text-gray-500 mt-1">{{ month.month }}</div>
            </div>
            {% endfor %}
        </div>
    </div>
    
    <!-- è¶£å‘³çµ±è¨ˆ -->
    <div class="bg-white rounded-lg shadow-sm p-4">
        <h2 class="font-semibold text-gray-800 mb-3">ğŸ² è¶£å‘³çµ±è¨ˆ</h2>
        <div class="grid grid-cols-2 gap-3">
            <div class="bg-purple-50 rounded-lg p-3 text-center">
                <div class="text-2xl">ğŸ‘‘</div>
                <div class="text-xl font-bold text-purple-700">{{ groups_created }}</div>
                <div class="text-xs text-purple-600">é–‹åœ˜æ¬¡æ•¸</div>
            </div>
            <div class="bg-yellow-50 rounded-lg p-3 text-center">
                <div class="text-2xl">ğŸ‰</div>
                <div class="text-xl font-bold text-yellow-700">{{ lucky_wins }}</div>
                <div class="text-xs text-yellow-600">ä¸­çæ¬¡æ•¸</div>
            </div>
            <div class="bg-pink-50 rounded-lg p-3 text-center">
                <div class="text-2xl">ğŸ¥³</div>
                <div class="text-xl font-bold text-pink-700">{{ treated_count }}</div>
                <div class="text-xs text-pink-600">è¢«è«‹å®¢æ¬¡æ•¸</div>
            </div>
            <div class="bg-red-50 rounded-lg p-3 text-center">
                <div class="text-2xl">ğŸ’</div>
                <div class="text-xl font-bold text-red-700">{{ treat_count }}</div>
                <div class="text-xs text-red-600">è«‹å®¢æ¬¡æ•¸</div>
            </div>
        </div>
    </div>
    
    <!-- ä¸‹å–®ç¿’æ…£ -->
    <div class="bg-white rounded-lg shadow-sm p-4">
        <h2 class="font-semibold text-gray-800 mb-3">â° ä¸‹å–®ç¿’æ…£</h2>
        <div class="grid grid-cols-2 gap-4">
            <div class="text-center">
                <div class="text-3xl font-bold text-orange-600">{{ peak_hour }}:00</div>
                <div class="text-sm text-gray-500">æœ€å¸¸ä¸‹å–®æ™‚é–“</div>
            </div>
            <div class="text-center">
                <div class="text-3xl font-bold text-orange-600">é€±{{ peak_weekday }}</div>
                <div class="text-sm text-gray-500">æœ€å¸¸ä¸‹å–®æ—¥</div>
            </div>
        </div>
    </div>
    
    <!-- é£²æ–™åå¥½ -->
    {% if sugar_stats or ice_stats %}
    <div class="bg-white rounded-lg shadow-sm p-4">
        <h2 class="font-semibold text-gray-800 mb-3">ğŸ¥¤ é£²æ–™åå¥½</h2>
        <div class="grid grid-cols-2 gap-4">
            {% if sugar_stats %}
            <div>
                <div class="text-sm text-gray-500 mb-2">ç”œåº¦</div>
                <div class="space-y-1">
                    {% for s in sugar_stats %}
                    <div class="flex items-center justify-between text-sm">
                        <span class="text-amber-700">{{ s.sugar }}</span>
                        <span class="text-gray-400">{{ s.count }}æ¬¡</span>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            {% if ice_stats %}
            <div>
                <div class="text-sm text-gray-500 mb-2">å†°å¡Š</div>
                <div class="space-y-1">
                    {% for i in ice_stats %}
                    <div class="flex items-center justify-between text-sm">
                        <span class="text-blue-700">{{ i.ice }}</span>
                        <span class="text-gray-400">{{ i.count }}æ¬¡</span>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
        
        {% if topping_stats %}
        <div class="mt-4 pt-4 border-t">
            <div class="text-sm text-gray-500 mb-2">æœ€æ„›åŠ æ–™</div>
            <div class="flex flex-wrap gap-2">
                {% for t in topping_stats %}
                <span class="px-2 py-1 bg-orange-100 text-orange-700 rounded text-sm">
                    {{ t.topping_name }} ({{ t.count }})
                </span>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
    {% endif %}
    
    <!-- æœ€æ„›åº—å®¶ TOP 5 -->
    {% if favorite_stores %}
    <div class="bg-white rounded-lg shadow-sm p-4">
        <h2 class="font-semibold text-gray-800 mb-3">â¤ï¸ æœ€æ„›åº—å®¶ TOP 5</h2>
        <div class="space-y-3">
            {% for store in favorite_stores %}
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 flex items-center justify-center font-bold 
                    {% if loop.index == 1 %}text-yellow-500 text-lg
                    {% elif loop.index == 2 %}text-gray-400
                    {% elif loop.index == 3 %}text-amber-600
                    {% else %}text-gray-300{% endif %}">
                    {% if loop.index <= 3 %}
                    {{ ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'][loop.index - 1] }}
                    {% else %}
                    {{ loop.index }}
                    {% endif %}
                </div>
                {% if store.logo_url %}
                <img src="{{ store.logo_url }}" class="w-10 h-10 rounded-lg object-contain bg-gray-50">
                {% else %}
                <div class="w-10 h-10 rounded-lg bg-gray-100 flex items-center justify-center text-xl">ğŸª</div>
                {% endif %}
                <div class="flex-1 min-w-0">
                    <div class="font-medium text-gray-800 truncate">{{ store.name }}</div>
                    <div class="text-xs text-gray-500">{{ store.order_count }} æ¬¡ Â· ${{ "{:,.0f}".format(store.total_spent or 0) }}</div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    
    <!-- æœ€å¸¸é»çš„å“é … TOP 10 -->
    {% if favorite_items %}
    <div class="bg-white rounded-lg shadow-sm p-4">
        <h2 class="font-semibold text-gray-800 mb-3">ğŸ”¥ æœ€å¸¸é»çš„å“é … TOP 10</h2>
        <div class="space-y-2">
            {% for item in favorite_items %}
            <div class="flex items-center justify-between py-2 {% if not loop.last %}border-b border-gray-100{% endif %}">
                <div class="flex items-center gap-2">
                    <span class="w-6 h-6 flex items-center justify-center text-sm 
                        {% if loop.index <= 3 %}bg-orange-100 text-orange-600{% else %}bg-gray-100 text-gray-500{% endif %} 
                        rounded-full font-medium">{{ loop.index }}</span>
                    <span class="text-gray-800">{{ item.item_name }}</span>
                </div>
                <div class="text-sm">
                    <span class="text-orange-600 font-medium">{{ item.total_qty|int }} ä»½</span>
                    <span class="text-gray-400 ml-2">${{ "{:,.0f}".format(item.total_spent or 0) }}</span>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    
    <!-- æœ€å¸¸è·Ÿåœ˜çš„åœ˜ä¸» -->
    {% if favorite_owners %}
    <div class="bg-white rounded-lg shadow-sm p-4">
        <h2 class="font-semibold text-gray-800 mb-3">ğŸ‘¥ æœ€å¸¸è·Ÿåœ˜çš„åœ˜ä¸»</h2>
        <div class="space-y-3">
            {% for owner in favorite_owners %}
            <div class="flex items-center gap-3">
                {% if owner.picture_url %}
                <img src="{{ owner.picture_url }}" class="w-10 h-10 rounded-full">
                {% else %}
                <div class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center text-xl">ğŸ‘¤</div>
                {% endif %}
                <div class="flex-1">
                    <div class="font-medium text-gray-800">{{ owner.nickname or owner.display_name }}</div>
                    <div class="text-xs text-gray-500">è·Ÿäº† {{ owner.follow_count }} åœ˜</div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    
    <!-- æ²’æœ‰è³‡æ–™ -->
    {% if total_orders == 0 %}
    <div class="text-center py-12 text-gray-500 bg-white rounded-lg">
        <div class="text-4xl mb-2">ğŸ“­</div>
        <p>é€™æ®µæœŸé–“æ²’æœ‰è¨‚å–®è¨˜éŒ„</p>
        <p class="text-sm mt-1">å¿«å»åƒåŠ ä¸€å€‹åœ˜å§ï¼</p>
    </div>
    {% endif %}
</div>
{% endblock %}
