<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>{% block title %}SELA å¿«é»ä¾†é»é¤{% endblock %}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        sela: {
                            50: '#FFF7ED',
                            100: '#FFEDD5',
                            200: '#FED7AA',
                            300: '#FDBA74',
                            400: '#FB923C',
                            500: '#F97316',
                            600: '#EA580C',
                            700: '#C2410C',
                        }
                    }
                }
            }
        }
    </script>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        [x-cloak] { display: none !important; }
        
        /* åŒ—æ­é¢¨æ»¾å‹•æ¢ */
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #FDBA74; border-radius: 4px; }
        
        /* å¹³æ»‘éæ¸¡ */
        * { transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); }
        
        /* å®‰å…¨å€åŸŸ */
        body { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body class="bg-sela-50/30 min-h-screen antialiased">
    <!-- HTMX å…¨å±€éŒ¯èª¤è™•ç† -->
    <script>
    document.body.addEventListener('htmx:responseError', function(evt) {
        if (evt.detail.xhr.status === 401) {
            window.location.href = '/login?next=' + encodeURIComponent(window.location.pathname);
        }
    });
    </script>
    
    <!-- Header - ç°¡æ½”åŒ—æ­é¢¨ -->
    <header class="bg-white/80 backdrop-blur-lg sticky top-0 z-40 border-b border-sela-100">
        <div class="max-w-lg mx-auto px-4 h-14 flex items-center justify-between">
            <!-- Logo -->
            <a href="/home" class="flex items-center gap-2">
                <img src="/static/images/sela-logo.jpg" alt="SELA" class="h-9 w-9 rounded-lg">
                <span class="font-bold text-sela-600 text-lg tracking-tight">SELA</span>
            </a>
            
            <!-- å³å´æ“ä½œ -->
            <div class="flex items-center gap-2">
                {% if user %}
                <!-- ç®¡ç†ï¼ˆç®¡ç†å“¡é™å®šï¼‰ -->
                {% if user.is_admin %}
                <a href="/admin" class="w-9 h-9 flex items-center justify-center rounded-full hover:bg-sela-50 transition-colors">
                    <span class="text-lg">âš™ï¸</span>
                </a>
                {% endif %}
                
                <!-- é–‹åœ˜æŒ‰éˆ• -->
                <a href="/groups/new" 
                   class="h-9 px-4 bg-sela-500 hover:bg-sela-600 text-white text-sm font-medium rounded-full flex items-center gap-1 transition-colors shadow-sm">
                    <span class="text-base">+</span> é–‹åœ˜
                </a>
                
                <!-- å€‹äººé ­åƒ -->
                <a href="/profile" class="w-9 h-9 rounded-full overflow-hidden border-2 border-sela-200 hover:border-sela-400 transition-colors">
                    {% if user.picture_url %}
                    <img src="{{ user.picture_url }}" class="w-full h-full object-cover">
                    {% else %}
                    <div class="w-full h-full bg-sela-100 flex items-center justify-center text-sela-500 text-sm font-bold">
                        {{ user.show_name[:1] }}
                    </div>
                    {% endif %}
                </a>
                {% endif %}
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-lg mx-auto px-4 py-5">
        {% block content %}{% endblock %}
    </main>
    
    <!-- åº•éƒ¨å°èˆªï¼ˆæ‰‹æ©Ÿå‹å–„ï¼‰ -->
    {% if user %}
    <nav class="fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur-lg border-t border-sela-100 z-40 safe-area-pb">
        <div class="max-w-lg mx-auto px-6 h-14 flex items-center justify-around">
            <a href="/home" class="flex flex-col items-center gap-0.5 text-sela-600">
                <span class="text-xl">ğŸ </span>
                <span class="text-[10px] font-medium">é¦–é </span>
            </a>
            <a href="/votes" class="flex flex-col items-center gap-0.5 text-gray-400 hover:text-sela-500">
                <span class="text-xl">ğŸ—³ï¸</span>
                <span class="text-[10px]">æŠ•ç¥¨</span>
            </a>
            <a href="/groups/new" class="flex flex-col items-center gap-0.5">
                <div class="w-12 h-12 -mt-6 bg-sela-500 rounded-full flex items-center justify-center shadow-lg">
                    <span class="text-white text-2xl">+</span>
                </div>
            </a>
            <a href="/feedback" class="flex flex-col items-center gap-0.5 text-gray-400 hover:text-sela-500">
                <span class="text-xl">ğŸ“®</span>
                <span class="text-[10px]">å›å ±</span>
            </a>
            <a href="/profile" class="flex flex-col items-center gap-0.5 text-gray-400 hover:text-sela-500">
                <span class="text-xl">ğŸ‘¤</span>
                <span class="text-[10px]">æˆ‘çš„</span>
            </a>
        </div>
    </nav>
    <div class="h-16"></div> <!-- åº•éƒ¨å°èˆªä½”ä½ -->
    {% endif %}
    
    {% if user %}
    <!-- é–’ç½®åµæ¸¬ -->
    <script>
    (function() {
        const IDLE_TIMEOUT = 30 * 60 * 1000;
        const HEARTBEAT_INTERVAL = 5 * 60 * 1000;
        let lastActivity = Date.now();
        let heartbeatTimer = null;
        
        function updateActivity() { lastActivity = Date.now(); }
        
        ['mousedown', 'keydown', 'scroll', 'touchstart'].forEach(event => {
            document.addEventListener(event, updateActivity, { passive: true });
        });
        
        async function heartbeat() {
            if (Date.now() - lastActivity > IDLE_TIMEOUT) {
                clearInterval(heartbeatTimer);
                window.location.href = '/login?next=' + encodeURIComponent(window.location.pathname);
                return;
            }
            try {
                const response = await fetch('/auth/heartbeat', { method: 'POST' });
                if (response.status === 401) {
                    clearInterval(heartbeatTimer);
                    window.location.href = '/login?next=' + encodeURIComponent(window.location.pathname);
                }
            } catch (e) {}
        }
        
        heartbeatTimer = setInterval(heartbeat, HEARTBEAT_INTERVAL);
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') heartbeat();
        });
    })();
    </script>
    {% endif %}
    
    {% block scripts %}{% endblock %}
</body>
</html>
