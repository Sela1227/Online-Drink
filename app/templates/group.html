{% extends "base.html" %}

{% block title %}{{ group.name }} - SELA Âø´Èªû‰æÜÈªûÈ§ê{% endblock %}

{% block content %}
<div class="space-y-4" x-data="orderPage()">
    <!-- Header -->
    <div class="bg-white rounded-lg shadow-sm p-4">
        <div class="flex gap-3">
            <!-- Logo -->
            <div class="w-16 h-16 bg-gray-100 rounded-lg flex items-center justify-center flex-shrink-0">
                {% if store.logo_url %}
                <img src="{{ store.logo_url }}" alt="{{ store.name }}" class="w-14 h-14 object-contain">
                {% else %}
                <span class="text-3xl">
                    {% if group.category.value == 'drink' %}üßã{% else %}üç±{% endif %}
                </span>
                {% endif %}
            </div>
            
            <!-- Ë≥áË®ä -->
            <div class="flex-1">
                <h1 class="font-bold text-lg text-gray-900">{{ group.name }}</h1>
                <div class="text-sm text-gray-500">{{ store.name }}</div>
                <div class="text-xs text-gray-400 mt-1">Âúò‰∏ªÔºö{{ group.owner.display_name }}</div>
            </div>
        </div>
        
        <!-- ÁãÄÊÖãËàáÊìç‰Ωú -->
        <div class="mt-4 flex items-center justify-between">
            <div>
                {% if is_open %}
                <span class="text-sm text-indigo-600 font-medium"
                      x-data="countdown('{{ group.deadline.isoformat() }}')"
                      x-text="'‚è∞ ' + display">
                </span>
                {% else %}
                <span class="text-sm text-gray-500">üîí Â∑≤Êà™Ê≠¢</span>
                {% endif %}
            </div>
            
            <div class="flex gap-2">
                <button @click="copyLink()" class="text-xs bg-gray-100 hover:bg-gray-200 px-3 py-1.5 rounded transition">
                    üìã Ë§áË£ΩÈÄ£Áµê
                </button>
                <button @click="showQR = true" class="text-xs bg-gray-100 hover:bg-gray-200 px-3 py-1.5 rounded transition">
                    üì± QR Code
                </button>
            </div>
        </div>
        
        <!-- ÂÇ¨ÂñÆÊèêÈÜí -->
        {% if pending_count > 0 %}
        <div class="mt-3 text-sm text-amber-600 bg-amber-50 px-3 py-2 rounded">
            ‚ö†Ô∏è {{ pending_count }} ‰∫∫Â∞öÊú™ÁµêÂñÆ
        </div>
        {% endif %}
        
        <!-- Âúò‰∏ªÊìç‰Ωú -->
        {% if is_owner and is_open %}
        <div class="mt-3 pt-3 border-t flex gap-2">
            <form action="/groups/{{ group.id }}/close" method="post" class="inline"
                  onsubmit="return confirm('Á¢∫ÂÆöË¶ÅÊèêÂâçÊà™Ê≠¢ÂóéÔºü')">
                <button type="submit" class="text-xs text-red-600 hover:text-red-700">
                    üõë ÊèêÂâçÊà™Ê≠¢
                </button>
            </form>
            <a href="/groups/{{ group.id }}/export/order" class="text-xs text-gray-600 hover:text-gray-700">
                üìù ÈªûÈ§êÊñáÂ≠ó
            </a>
            <a href="/groups/{{ group.id }}/export/payment" class="text-xs text-gray-600 hover:text-gray-700">
                üí∞ Êî∂Ê¨æÊñáÂ≠ó
            </a>
        </div>
        {% endif %}
    </div>

    <!-- Ë®ÇÂñÆÁâÜ -->
    <div id="order-wall" hx-get="/groups/{{ group.id }}/orders/wall" hx-trigger="load, orderUpdated from:body">
        {% include "partials/order_wall.html" %}
    </div>

    <!-- ÊàëÁöÑË®ÇÂñÆ -->
    <div id="my-order" hx-get="/groups/{{ group.id }}/orders/mine" hx-trigger="load, orderUpdated from:body">
        {% include "partials/my_order.html" %}
    </div>

    <!-- ËèúÂñÆ -->
    {% if is_open %}
    <div class="bg-white rounded-lg shadow-sm p-4">
        <h2 class="font-semibold text-gray-800 mb-3">ËèúÂñÆ</h2>
        
        <!-- Âø´ÈÅ∏ÂìÅÈ†Ö -->
        {% if quick_selections.my_frequent or quick_selections.my_recent or quick_selections.store_popular %}
        <div class="mb-4 space-y-3">
            <!-- ÊàëÁöÑÂ∏∏Èªû -->
            {% if quick_selections.my_frequent %}
            <div>
                <h3 class="text-xs font-medium text-gray-500 mb-2">‚≠ê ÊàëÁöÑÂ∏∏Èªû</h3>
                <div class="flex flex-wrap gap-2">
                    {% for item in quick_selections.my_frequent %}
                    <button type="button"
                            class="text-sm px-3 py-1.5 rounded-full bg-amber-50 text-amber-700 border border-amber-200 hover:bg-amber-100 transition"
                            @click="quickAdd({{ item.id }}, '{{ item.name }}', {{ item.price }})">
                        {{ item.name }} ${{ item.price }}
                    </button>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            
            <!-- ÊúÄËøëÈªûÈÅé -->
            {% if quick_selections.my_recent %}
            <div>
                <h3 class="text-xs font-medium text-gray-500 mb-2">üïê ÊúÄËøëÈªûÈÅé</h3>
                <div class="flex flex-wrap gap-2">
                    {% for item in quick_selections.my_recent %}
                    <button type="button"
                            class="text-sm px-3 py-1.5 rounded-full bg-blue-50 text-blue-700 border border-blue-200 hover:bg-blue-100 transition"
                            @click="quickAdd({{ item.id }}, '{{ item.name }}', {{ item.price }})">
                        {{ item.name }} ${{ item.price }}
                    </button>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            
            <!-- Â∫óÂÆ∂ÁÜ±ÈñÄ -->
            {% if quick_selections.store_popular %}
            <div>
                <h3 class="text-xs font-medium text-gray-500 mb-2">üî• Â∫óÂÆ∂ÁÜ±ÈñÄ</h3>
                <div class="flex flex-wrap gap-2">
                    {% for item in quick_selections.store_popular %}
                    <button type="button"
                            class="text-sm px-3 py-1.5 rounded-full bg-rose-50 text-rose-700 border border-rose-200 hover:bg-rose-100 transition"
                            @click="quickAdd({{ item.id }}, '{{ item.name }}', {{ item.price }})">
                        {{ item.name }} ${{ item.price }}
                    </button>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
        <hr class="my-4">
        {% endif %}
        
        <!-- ÂàÜÈ°ûÂìÅÈ†Ö -->
        {% for category in menu.categories %}
        <div class="mb-4">
            <h3 class="text-sm font-medium text-gray-600 mb-2">{{ category.name }}</h3>
            <div class="space-y-2">
                {% for item in category.items %}
                {% include "partials/menu_item.html" %}
                {% endfor %}
            </div>
        </div>
        {% endfor %}
        
        <!-- ÁÑ°ÂàÜÈ°ûÂìÅÈ†Ö -->
        {% set uncategorized = menu.items | selectattr('category_id', 'none') | list %}
        {% if uncategorized %}
        <div class="space-y-2">
            {% for item in uncategorized %}
            {% include "partials/menu_item.html" %}
            {% endfor %}
        </div>
        {% endif %}
    </div>
    {% endif %}

    <!-- QR Code Modal -->
    <div x-show="showQR" x-cloak
         class="fixed inset-0 bg-black/50 flex items-center justify-center z-50"
         @click.self="showQR = false">
        <div class="bg-white rounded-lg p-6 mx-4 max-w-sm w-full text-center">
            <h3 class="font-semibold mb-4">ÊéÉÁ¢ºÂä†ÂÖ•ÂúòË≥º</h3>
            <div hx-get="/groups/{{ group.id }}/qrcode" hx-trigger="load" class="flex justify-center">
                <div class="animate-pulse bg-gray-200 w-48 h-48"></div>
            </div>
            <button @click="showQR = false" class="mt-4 text-gray-500 hover:text-gray-700">ÈóúÈñâ</button>
        </div>
    </div>

    <!-- Âä†ÂÖ•ÂìÅÈ†Ö Modal -->
    <div x-show="showAddItem" x-cloak
         class="fixed inset-0 bg-black/50 flex items-end sm:items-center justify-center z-50"
         @click.self="showAddItem = false">
        <div class="bg-white rounded-t-2xl sm:rounded-lg p-6 w-full max-w-lg">
            <h3 class="font-semibold text-lg mb-4" x-text="selectedItem?.name"></h3>
            
            <form hx-post="/groups/{{ group.id }}/orders/items" 
                  hx-target="#my-order"
                  hx-swap="innerHTML"
                  @htmx:after-request="showAddItem = false; $dispatch('orderUpdated')">
                
                <input type="hidden" name="menu_item_id" :value="selectedItem?.id">
                
                <!-- Â∞∫ÂØ∏ÈÅ∏Êìá (È£≤ÊñôÂúò‰∏îÊúâÈõôÂÉπÊ†º) -->
                {% if group.category.value == 'drink' %}
                <div x-show="selectedItem?.has_sizes" class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Â∞∫ÂØ∏</label>
                    <div class="flex gap-2">
                        <label class="cursor-pointer flex-1">
                            <input type="radio" name="size" value="M" x-model="selectedSize" class="peer hidden" checked>
                            <span class="block text-center px-4 py-2 rounded border peer-checked:bg-orange-500 peer-checked:text-white peer-checked:border-orange-500">
                                M <span class="text-sm" x-text="'$' + selectedItem?.price"></span>
                            </span>
                        </label>
                        <label class="cursor-pointer flex-1">
                            <input type="radio" name="size" value="L" x-model="selectedSize" class="peer hidden">
                            <span class="block text-center px-4 py-2 rounded border peer-checked:bg-orange-500 peer-checked:text-white peer-checked:border-orange-500">
                                L <span class="text-sm" x-text="'$' + selectedItem?.price_l"></span>
                            </span>
                        </label>
                    </div>
                </div>
                
                <!-- ÁîúÂ∫¶ -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">ÁîúÂ∫¶</label>
                    {% if group.lock_sugar %}
                    <div class="text-gray-600">{{ group.default_sugar }} (Â∑≤ÈéñÂÆö)</div>
                    <input type="hidden" name="sugar" value="{{ group.default_sugar }}">
                    {% else %}
                    <div class="flex flex-wrap gap-2">
                        {% for opt in store.options if opt.option_type.value == 'sugar' %}
                        <label class="cursor-pointer">
                            <input type="radio" name="sugar" value="{{ opt.option_value }}" 
                                   class="peer hidden" {% if opt.option_value == group.default_sugar %}checked{% endif %}>
                            <span class="block px-3 py-1.5 rounded border peer-checked:bg-orange-500 peer-checked:text-white peer-checked:border-orange-500">
                                {{ opt.option_value }}
                            </span>
                        </label>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
                
                <!-- ÂÜ∞Â°ä -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">ÂÜ∞Â°ä</label>
                    {% if group.lock_ice %}
                    <div class="text-gray-600">{{ group.default_ice }} (Â∑≤ÈéñÂÆö)</div>
                    <input type="hidden" name="ice" value="{{ group.default_ice }}">
                    {% else %}
                    <div class="flex flex-wrap gap-2">
                        {% for opt in store.options if opt.option_type.value == 'ice' %}
                        <label class="cursor-pointer">
                            <input type="radio" name="ice" value="{{ opt.option_value }}" 
                                   class="peer hidden" {% if opt.option_value == group.default_ice %}checked{% endif %}>
                            <span class="block px-3 py-1.5 rounded border peer-checked:bg-orange-500 peer-checked:text-white peer-checked:border-orange-500">
                                {{ opt.option_value }}
                            </span>
                        </label>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
                {% endif %}
                
                <!-- ÂìÅÈ†ÖÈÅ∏È†Ö (Ë®ÇÈ§ê) -->
                <div x-show="selectedItem?.options?.length > 0" class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Âä†Ë≥ºÈÅ∏È†Ö</label>
                    <div class="space-y-2" x-html="renderOptions()"></div>
                </div>
                
                <!-- ÊùØÊï∏ -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Êï∏Èáè</label>
                    <div class="flex items-center gap-3">
                        <button type="button" @click="quantity = Math.max(1, quantity - 1)"
                                class="w-10 h-10 rounded-full bg-gray-100 hover:bg-gray-200 text-xl">‚àí</button>
                        <input type="number" name="quantity" x-model="quantity" min="1" 
                               class="w-16 text-center border rounded py-2">
                        <button type="button" @click="quantity++"
                                class="w-10 h-10 rounded-full bg-gray-100 hover:bg-gray-200 text-xl">+</button>
                    </div>
                </div>
                
                <!-- ÂÇôË®ª -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">ÂÇôË®ª</label>
                    <input type="text" name="note" placeholder="‰æãÔºöÂ∞ëÂÜ∞„ÄÅÂéªÂÜ∞..." 
                           class="w-full border rounded px-3 py-2">
                </div>
                
                <!-- ÊåâÈàï -->
                <div class="flex gap-2">
                    <button type="button" @click="showAddItem = false"
                            class="flex-1 py-3 rounded-lg border hover:bg-gray-50">
                        ÂèñÊ∂à
                    </button>
                    <button type="submit"
                            class="flex-1 py-3 rounded-lg bg-orange-500 hover:bg-orange-600 text-white font-medium">
                        Âä†ÂÖ•Ë≥ºÁâ©Ëªä
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function orderPage() {
    return {
        showQR: false,
        showAddItem: false,
        selectedItem: null,
        selectedSize: 'M',
        quantity: 1,
        
        openAddItem(item) {
            this.selectedItem = item;
            this.selectedSize = 'M';
            this.quantity = 1;
            this.showAddItem = true;
        },
        
        quickAdd(itemId, itemName, itemPrice, itemPriceL = null) {
            // Âø´ÈÅ∏ÂìÅÈ†ÖÔºöÁõ¥Êé•ÊâìÈñã modal ‰∏¶È†êË®≠Ë≥áÊñô
            this.selectedItem = {
                id: itemId,
                name: itemName,
                price: itemPrice,
                price_l: itemPriceL,
                has_sizes: itemPriceL !== null,
                options: []
            };
            this.selectedSize = 'M';
            this.quantity = 1;
            this.showAddItem = true;
        },
        
        copyLink() {
            navigator.clipboard.writeText(window.location.href).then(() => {
                showToast('ÈÄ£ÁµêÂ∑≤Ë§áË£ΩÔºÅ', 'success');
            }).catch(() => {
                showToast('Ë§áË£ΩÂ§±Êïó', 'error');
            });
        },
        
        renderOptions() {
            if (!this.selectedItem?.options) return '';
            return this.selectedItem.options.map(opt => `
                <label class="flex items-center gap-2 cursor-pointer">
                    <input type="checkbox" name="options" value="${opt.id}" class="rounded">
                    <span>${opt.name}</span>
                    ${opt.price_diff > 0 ? `<span class="text-gray-500">+$${opt.price_diff}</span>` : ''}
                </label>
            `).join('');
        }
    }
}

// HTMX ‰∫ã‰ª∂Áõ£ËÅΩÔºöÈ°ØÁ§∫ÊàêÂäü/ÈåØË™§Ë®äÊÅØ
document.body.addEventListener('htmx:afterRequest', function(evt) {
    if (evt.detail.successful) {
        if (evt.detail.pathInfo.requestPath.includes('/orders/items')) {
            showToast('Â∑≤Âä†ÂÖ•Ë≥ºÁâ©Ëªä', 'success');
        } else if (evt.detail.pathInfo.requestPath.includes('/orders/submit')) {
            showToast('Ë®ÇÂñÆÂ∑≤ÈÄÅÂá∫ÔºÅ', 'success');
        }
    }
});

document.body.addEventListener('htmx:responseError', function(evt) {
    showToast('Êìç‰ΩúÂ§±ÊïóÔºåË´ãÈáçË©¶', 'error');
});

function countdown(deadline) {
    return {
        display: '',
        init() {
            this.update();
            setInterval(() => this.update(), 1000);
        },
        update() {
            const now = new Date();
            const end = new Date(deadline);
            const diff = end - now;
            
            if (diff <= 0) {
                this.display = 'Â∑≤Êà™Ê≠¢';
                return;
            }
            
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);
            
            if (hours > 0) {
                this.display = `${hours}h ${minutes}m`;
            } else {
                this.display = `${minutes}m ${seconds}s`;
            }
        }
    }
}
</script>
{% endblock %}
