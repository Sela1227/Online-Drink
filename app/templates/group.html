{% extends "base.html" %}

{% block title %}{{ group.name }} - SELA å¿«é»ä¾†é»é¤{% endblock %}

{% block content %}
<div class="space-y-4" x-data="orderPage()">
    <!-- Header -->
    <div class="bg-white rounded-lg shadow-sm p-4">
        <a href="/home" class="text-sm text-gray-500 hover:text-gray-700">â† è¿”å›é¦–é </a>
        
        <!-- ç°¡æ½”çš„åœ˜å–®è³‡è¨Š -->
        <div class="flex items-center gap-3 mt-2">
            <div class="w-12 h-12 bg-gray-100 rounded-lg flex items-center justify-center flex-shrink-0">
                {% if store.logo_url %}
                <img src="{{ store.logo_url }}" alt="{{ store.name }}" class="w-10 h-10 object-contain">
                {% else %}
                <span class="text-2xl">{{ group.category_icon }}</span>
                {% endif %}
            </div>
            <div class="flex-1 min-w-0">
                <h1 class="font-bold text-lg text-gray-900 truncate">{{ group.name }}</h1>
                <div class="text-sm text-gray-500 flex items-center gap-1">
                    {{ store.name }} Â· {{ group.owner.show_name }}
                    <button onclick="toggleFavorite({{ store.id }})" 
                            id="fav-btn"
                            class="ml-2 flex items-center gap-0.5 hover:scale-105 transition-transform"
                            title="{% if is_favorited %}å–æ¶ˆæ”¶è—{% else %}æ”¶è—åº—å®¶{% endif %}">
                        <span class="text-lg">{% if is_favorited %}â­{% else %}â˜†{% endif %}</span>
                        <span class="text-xs text-gray-400" id="fav-text">{% if is_favorited %}å·²æ”¶è—{% else %}æ”¶è—{% endif %}</span>
                    </button>
                </div>
            </div>
            <div class="text-right">
                {% if is_open %}
                <div class="text-orange-600 font-medium"
                     x-data="countdown('{{ group.deadline.isoformat() }}')"
                     x-text="display"></div>
                {% else %}
                <div class="text-gray-500">å·²æˆªæ­¢</div>
                {% endif %}
            </div>
        </div>
        
        <!-- å‚™è¨»é¡¯ç¤º -->
        {% if group.note %}
        <div class="mt-3 p-3 bg-amber-50 rounded-lg text-sm text-amber-800">
            ğŸ“ {{ group.note }}
        </div>
        {% endif %}
        
        <!-- è¶£å‘³åŠŸèƒ½ç‹€æ…‹æç¤º -->
        {% if group.is_blind_mode and is_open %}
        <div class="mt-3 p-3 bg-purple-50 rounded-lg text-sm text-purple-800">
            ğŸ™ˆ <strong>ç›²é»æ¨¡å¼</strong>ï¼šæˆªæ­¢å‰ç„¡æ³•çœ‹åˆ°å…¶ä»–äººé»äº†ä»€éº¼ï¼Œæˆªæ­¢å¾Œä¸€èµ·æ­æ›‰ï¼
        </div>
        {% endif %}
        
        {% if group.enable_lucky_draw %}
        <div class="mt-3 p-3 bg-pink-50 rounded-lg text-sm text-pink-800">
            ğŸŠ <strong>éš¨æ©Ÿå…å–®</strong>ï¼šçµå–®æ™‚å°‡æŠ½é¸ {{ group.lucky_draw_count }} äººå…å–®ï¼
            {% if not is_open and group.lucky_winner_ids %}
            <div class="mt-2 font-bold text-lg">
                ğŸ‰ æ­å–œ 
                {% for winner_id in group.lucky_winner_ids.split(',') %}
                    {% for order in submitted_orders if order.user_id == winner_id|int %}
                        {{ order.user.show_name }}{% if not loop.last %}ã€{% endif %}
                    {% endfor %}
                {% endfor %}
                 ä¸­çå…å–®ï¼
            </div>
            {% endif %}
        </div>
        {% endif %}
        
        {% if group.treat_user_id %}
        <div class="mt-3 p-3 bg-red-50 rounded-lg text-sm text-red-800 flex items-center justify-between">
            <div>
                ğŸ’ <strong>{{ treat_user.show_name if treat_user else 'æŸäºº' }} è«‹å®¢ï¼</strong> æœ¬åœ˜ç”± TA è²·å–®
            </div>
            {% if user.id == group.treat_user_id or is_owner or is_admin %}
            <form action="/groups/{{ group.id }}/cancel-treat" method="post" class="inline"
                  onsubmit="return confirm('ç¢ºå®šè¦å–æ¶ˆè«‹å®¢å—ï¼Ÿ')">
                <button type="submit" class="text-red-600 hover:text-red-700 text-xs">å–æ¶ˆè«‹å®¢</button>
            </form>
            {% endif %}
        </div>
        {% endif %}
        
        <!-- å¤–é€è²»é¡¯ç¤º -->
        {% if group.delivery_fee %}
        <div class="mt-2 p-3 bg-blue-50 rounded-lg text-sm text-blue-800 flex items-center justify-between">
            <div>
                ğŸš— å¤–é€è²»ï¼š${{ group.delivery_fee|int }}
            </div>
            <div class="text-blue-600">
                {% if group.submitted_count > 0 %}
                æ¯äººåˆ†æ”¤ ${{ group.delivery_fee_per_person|int }}ï¼ˆ{{ group.submitted_count }} äººï¼‰
                {% else %}
                ç­‰å¾…çµå–®å¾Œè¨ˆç®—åˆ†æ”¤
                {% endif %}
            </div>
        </div>
        {% endif %}
        
        <!-- æ“ä½œæŒ‰éˆ• -->
        <div class="flex items-center justify-between mt-3 pt-3 border-t text-xs">
            <div class="flex gap-3">
                <button @click="copyLink()" class="text-gray-600 hover:text-gray-800">è¤‡è£½é€£çµ</button>
                <button @click="showQR = true" class="text-gray-600 hover:text-gray-800">QR Code</button>
            </div>
            {% if is_owner or is_admin %}
            <div class="flex gap-3 items-center">
                {% if is_open and pending_count > 0 %}
                <button @click="showReminder = true" class="text-amber-600 hover:text-amber-700">ğŸ“¢ å‚¬å–®</button>
                {% endif %}
                <button @click="showSettings = true" class="text-blue-600 hover:text-blue-700">ä¿®æ”¹</button>
                {% if is_open %}
                <form action="/groups/{{ group.id }}/close" method="post" class="inline"
                      onsubmit="return confirm('ç¢ºå®šè¦ææ—©çµå–®å—ï¼Ÿçµå–®å¾Œå°‡ç„¡æ³•å†{% if group.category.value == 'group_buy' %}ä¸‹å–®{% else %}é»é¤{% endif %}ã€‚')">
                    <button type="submit" class="text-orange-600 hover:text-orange-700">ææ—©çµå–®</button>
                </form>
                {% endif %}
                <a href="/groups/{{ group.id }}/export/order" class="text-gray-600 hover:text-gray-800">åº—å®¶æ˜ç´°</a>
                <a href="/groups/{{ group.id }}/export/payment" class="text-gray-600 hover:text-gray-800">å€‹äººæ˜ç´°</a>
                <a href="/groups/{{ group.id }}/export/excel" class="text-green-600 hover:text-green-700">ğŸ“¥ Excel</a>
            </div>
            {% endif %}
        </div>
        
        {% if pending_count > 0 %}
        <div class="mt-2 text-sm text-amber-600 bg-amber-50 px-3 py-1.5 rounded flex items-center justify-between">
            <span>{{ pending_count }} äººå°šæœªçµå–®</span>
            {% if is_owner or is_admin %}
            <button @click="showReminder = true" class="text-amber-700 hover:text-amber-800 font-medium">æŸ¥çœ‹åå–®</button>
            {% endif %}
        </div>
        {% endif %}
    </div>
    
    <!-- åœ˜å–®è¨­å®š Modal -->
    {% if is_owner or is_admin %}
    <div x-show="showSettings" x-cloak
         class="fixed inset-0 z-50 flex items-center justify-center bg-black/50"
         @click.self="showSettings = false">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md mx-4 max-h-[80vh] overflow-y-auto">
            <div class="p-4 border-b flex justify-between items-center sticky top-0 bg-white">
                <h3 class="font-bold text-lg">åœ˜å–®è¨­å®š</h3>
                <button @click="showSettings = false" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
            </div>
            
            <div class="p-4 space-y-4">
                <!-- ç·¨è¼¯åœ˜å–® -->
                <div class="border rounded-lg p-3">
                    <h4 class="font-medium text-gray-800 mb-2">ç·¨è¼¯åœ˜å–®</h4>
                    <form action="/groups/{{ group.id }}/edit" method="post" class="space-y-3">
                        <div>
                            <label class="block text-sm text-gray-600 mb-1">åœ˜å</label>
                            <input type="text" name="name" value="{{ group.name }}" required
                                   class="w-full border rounded px-3 py-2 text-sm">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-600 mb-1">å‚™è¨»</label>
                            <textarea name="note" rows="2" class="w-full border rounded px-3 py-2 text-sm"
                                      placeholder="å–é¤åœ°é»ç­‰">{{ group.note or '' }}</textarea>
                        </div>
                        <div>
                            <label class="block text-sm text-gray-600 mb-1">å¤–é€è²»</label>
                            <div class="flex items-center gap-2">
                                <span class="text-gray-500">$</span>
                                <input type="number" name="delivery_fee" min="0" step="1"
                                       value="{{ group.delivery_fee|int if group.delivery_fee else '' }}"
                                       placeholder="0"
                                       class="w-24 border rounded px-3 py-2 text-sm">
                                <span class="text-xs text-gray-400">è‡ªå‹•åˆ†æ”¤</span>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm text-gray-600 mb-1">æˆªæ­¢æ™‚é–“</label>
                            <input type="datetime-local" name="deadline" 
                                   value="{{ group.deadline.strftime('%Y-%m-%dT%H:%M') }}"
                                   class="w-full border rounded px-3 py-2 text-sm">
                        </div>
                        <button type="submit" class="w-full bg-orange-500 hover:bg-orange-600 text-white py-2 rounded text-sm">
                            å„²å­˜è®Šæ›´
                        </button>
                    </form>
                </div>
                
                <!-- è½‰ç§»åœ˜ä¸» -->
                <div class="border rounded-lg p-3">
                    <h4 class="font-medium text-gray-800 mb-2">è½‰ç§»åœ˜ä¸»</h4>
                    <form action="/groups/{{ group.id }}/transfer" method="post"
                          onsubmit="return confirm('ç¢ºå®šè¦å°‡åœ˜ä¸»è½‰ç§»çµ¦é¸æ“‡çš„ç”¨æˆ¶å—ï¼Ÿ')">
                        <div class="mb-3">
                            <label class="block text-sm text-gray-600 mb-1">é¸æ“‡æ–°åœ˜ä¸»</label>
                            <select name="new_owner_id" required class="w-full border rounded px-3 py-2 text-sm">
                                <option value="">è«‹é¸æ“‡...</option>
                                {% for u in all_users %}
                                {% if u.id != group.owner_id %}
                                <option value="{{ u.id }}">{{ u.show_name }}</option>
                                {% endif %}
                                {% endfor %}
                            </select>
                        </div>
                        <button type="submit" class="w-full bg-blue-500 hover:bg-blue-600 text-white py-2 rounded text-sm">
                            è½‰ç§»åœ˜ä¸»
                        </button>
                    </form>
                </div>
                
                <!-- è¨ªå®¢é€£çµ -->
                <div class="border rounded-lg p-3" x-data="{ showGuestLink: false, guestLink: '' }">
                    <h4 class="font-medium text-gray-800 mb-2">ğŸ‘¤ è¨ªå®¢é€£çµ</h4>
                    <p class="text-xs text-gray-500 mb-3">è®“éç³»çµ±æˆå“¡ä¹Ÿèƒ½è‡¨æ™‚åƒèˆ‡æ­¤åœ˜</p>
                    <button type="button" 
                            @click="fetch('/groups/{{ group.id }}/guest-link', {method: 'POST'}).then(r => r.json()).then(d => { guestLink = d.link; showGuestLink = true; })"
                            class="w-full bg-gray-100 hover:bg-gray-200 text-gray-700 py-2 rounded text-sm">
                        ç”¢ç”Ÿè¨ªå®¢é€£çµ
                    </button>
                    <div x-show="showGuestLink" x-cloak class="mt-3">
                        <div class="flex items-center gap-2">
                            <input type="text" x-model="guestLink" readonly
                                   class="flex-1 border rounded px-2 py-1 text-xs bg-gray-50">
                            <button @click="navigator.clipboard.writeText(guestLink).then(() => alert('å·²è¤‡è£½ï¼'))"
                                    class="text-sm text-blue-600 hover:text-blue-800">è¤‡è£½</button>
                        </div>
                        <p class="text-xs text-gray-400 mt-1">é€£çµæœ‰æ•ˆæœŸ 24 å°æ™‚</p>
                    </div>
                </div>
                
                <!-- åˆªé™¤åœ˜å–® -->
                <div class="border border-red-200 rounded-lg p-3 bg-red-50">
                    <h4 class="font-medium text-red-800 mb-2">åˆªé™¤åœ˜å–®</h4>
                    <p class="text-sm text-red-600 mb-3">
                        {% if group.orders|length > 0 %}
                        âš ï¸ æ­¤åœ˜å·²æœ‰ {{ group.orders|length }} ç­†è¨‚å–®ï¼Œåˆªé™¤å¾Œç„¡æ³•å¾©åŸï¼
                        {% else %}
                        åˆªé™¤å¾Œç„¡æ³•å¾©åŸ
                        {% endif %}
                    </p>
                    <form action="/groups/{{ group.id }}/delete" method="post"
                          onsubmit="return confirm('{% if group.orders|length > 0 %}æ­¤åœ˜å·²æœ‰ {{ group.orders|length }} ç­†è¨‚å–®ï¼{% endif %}ç¢ºå®šè¦åˆªé™¤å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')">
                        <button type="submit" class="w-full bg-red-500 hover:bg-red-600 text-white py-2 rounded text-sm">
                            åˆªé™¤åœ˜å–®
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- å‚¬å–® Modal -->
    {% if (is_owner or is_admin) and pending_orders %}
    <div x-show="showReminder" x-cloak
         class="fixed inset-0 z-50 flex items-center justify-center bg-black/50"
         @click.self="showReminder = false">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm mx-4">
            <div class="p-4 border-b">
                <h3 class="font-semibold text-gray-800">ğŸ“¢ å‚¬å–®æé†’</h3>
            </div>
            
            <div class="p-4">
                <p class="text-sm text-gray-600 mb-3">ä»¥ä¸‹ {{ pending_orders|length }} äººå°šæœªçµå–®ï¼š</p>
                
                <div class="bg-gray-50 rounded-lg p-3 mb-4 max-h-60 overflow-y-auto">
                    <div class="space-y-2">
                        {% for order in pending_orders %}
                        <div class="flex items-center gap-2 text-sm">
                            {% if order.user.picture_url %}
                            <img src="{{ order.user.picture_url }}" class="w-6 h-6 rounded-full">
                            {% endif %}
                            <span class="font-medium">{{ order.user.show_name }}</span>
                            <span class="text-gray-400">ï¼ˆ{{ order.items|length }} é …ï¼Œ${{ order.total_amount }}ï¼‰</span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                
                <!-- è¤‡è£½åå–® -->
                <div class="mb-4">
                    <label class="block text-sm text-gray-600 mb-1">è¤‡è£½åå–®</label>
                    <div class="flex gap-2">
                        <input type="text" id="pending-names" readonly
                               value="{% for order in pending_orders %}{{ order.user.show_name }}{% if not loop.last %}ã€{% endif %}{% endfor %}"
                               class="flex-1 border rounded px-3 py-2 text-sm bg-gray-50">
                        <button type="button" onclick="copyPendingNames()"
                                class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded text-sm">
                            è¤‡è£½
                        </button>
                    </div>
                </div>
                
                <!-- æç¤ºæ–‡å­— -->
                <p class="text-xs text-gray-400 mb-4">
                    ä½ å¯ä»¥è¤‡è£½åå–®ï¼Œè²¼åˆ° LINE ç¾¤çµ„æé†’å¤§å®¶çµå–®
                </p>
            </div>
            
            <div class="p-4 border-t bg-gray-50 rounded-b-lg">
                <button @click="showReminder = false"
                        class="w-full py-2 rounded-lg border hover:bg-gray-100 text-sm">
                    é—œé–‰
                </button>
            </div>
        </div>
    </div>
    
    <script>
    function copyPendingNames() {
        const input = document.getElementById('pending-names');
        input.select();
        document.execCommand('copy');
        alert('å·²è¤‡è£½åå–®ï¼');
    }
    </script>
    {% endif %}

    <!-- è¨‚å–®ç‰† -->
    <div id="order-wall" hx-get="/groups/{{ group.id }}/orders/wall" hx-trigger="load, orderUpdated from:body">
        {% include "partials/order_wall.html" %}
    </div>

    <!-- æˆ‘çš„è¨‚å–®ï¼ˆå·²çµå–®æ™‚é¡¯ç¤ºåœ¨é é¢ä¸Šï¼‰ -->
    <div id="my-order-display" x-show="orderStatus === 'submitted'">
        <div class="bg-white rounded-lg shadow-sm p-4">
            <h2 class="font-semibold text-gray-800 mb-3 flex items-center gap-2">
                æˆ‘çš„è¨‚å–®
                <span class="text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded">å·²çµå–®</span>
                {% if not group.treat_user_id %}
                <form action="/groups/{{ group.id }}/treat" method="post" class="ml-auto"
                      onsubmit="return confirm('ç¢ºå®šè¦è«‹å®¢å—ï¼Ÿæœ¬åœ˜å°‡ç”±ä½ è²·å–®ï¼')">
                    <button type="submit" class="text-sm bg-red-50 text-red-600 hover:bg-red-100 px-3 py-1 rounded-full transition">
                        ğŸ’ æˆ‘è«‹å®¢
                    </button>
                </form>
                {% endif %}
            </h2>
            <div id="my-order-content" hx-get="/groups/{{ group.id }}/orders/mine" hx-trigger="load, orderUpdated from:body">
                {% include "partials/my_order.html" %}
            </div>
        </div>
    </div>

    <!-- å¿«é€Ÿä¸‹å–®ï¼ˆåœ˜é–‹æ”¾ä¸­ä¸”å°šæœªçµå–®æ™‚é¡¯ç¤ºï¼‰ -->
    {% if is_open %}
    <div class="bg-white rounded-lg shadow-sm p-4" x-show="orderStatus !== 'submitted'">
        <h2 class="font-semibold text-gray-800 mb-3">âš¡ {% if group.category.value == 'group_buy' %}å¿«é€Ÿä¸‹å–®{% else %}å¿«é€Ÿé»é¤{% endif %}</h2>
        
        <div class="flex flex-wrap gap-2 mb-3">
            <!-- è¤‡è£½ä¸Šæ¬¡è¨‚å–® -->
            {% if last_order and last_order_items %}
            <button @click="showLastOrder = true"
                    class="flex items-center gap-1.5 px-3 py-2 bg-blue-50 text-blue-700 rounded-lg text-sm hover:bg-blue-100 transition">
                ğŸ“‹ ä¸Šæ¬¡è¨‚å–®
            </button>
            {% endif %}
            
            <!-- çœ‹åˆ¥äººé»ä»€éº¼ï¼ˆç›²é»æ¨¡å¼ä¸‹éš±è—ï¼‰ -->
            {% if submitted_orders|length > 0 and not group.is_blind_mode %}
            <button @click="showOthersOrders = true"
                    class="flex items-center gap-1.5 px-3 py-2 bg-green-50 text-green-700 rounded-lg text-sm hover:bg-green-100 transition">
                ğŸ‘€ çœ‹åˆ¥äººé»ä»€éº¼
            </button>
            {% endif %}
            
            <!-- éš¨æ©Ÿé¸æ“‡å™¨ -->
            <button @click="randomPick()"
                    class="flex items-center gap-1.5 px-3 py-2 bg-purple-50 text-purple-700 rounded-lg text-sm hover:bg-purple-100 transition">
                ğŸ² éš¨æ©Ÿé¸
            </button>
        </div>
        
        <!-- å¸¸é»æ¸…å–® -->
        {% if favorite_items %}
        <div class="border-t pt-3">
            <div class="text-xs text-gray-500 mb-2">â¤ï¸ ä½ åœ¨ {{ store.name }} çš„å¸¸é»</div>
            <div class="flex flex-wrap gap-2">
                {% for fav in favorite_items %}
                <button onclick="scrollToItem({{ fav.menu_item_id }})"
                        class="text-xs px-2.5 py-1.5 bg-orange-50 text-orange-700 rounded-full hover:bg-orange-100 transition">
                    {{ fav.item_name }} <span class="text-orange-400">({{ fav.count }})</span>
                </button>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
    
    <!-- çœ‹åˆ¥äººé»ä»€éº¼ Modal -->
    {% if submitted_orders|length > 0 %}
    <div x-show="showOthersOrders" x-cloak
         class="fixed inset-0 z-50 flex items-center justify-center bg-black/50"
         @click.self="showOthersOrders = false">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm mx-4 max-h-[80vh] flex flex-col">
            <div class="p-4 border-b flex justify-between items-center">
                <h3 class="font-semibold text-gray-800">ğŸ‘€ å¤§å®¶éƒ½é»ä»€éº¼</h3>
                <button @click="showOthersOrders = false" class="text-gray-400 hover:text-gray-600 text-xl">&times;</button>
            </div>
            
            <div class="p-4 overflow-y-auto flex-1">
                <div class="space-y-3">
                    {% for order in submitted_orders %}
                    {% if order.user_id != user.id %}
                    <div class="bg-gray-50 rounded-lg p-3">
                        <div class="font-medium text-gray-800 mb-2">{{ order.user.show_name }}</div>
                        <div class="space-y-2">
                            {% for item in order.items %}
                            <div class="flex items-center justify-between text-sm gap-2">
                                <div class="flex-1 min-w-0">
                                    <span class="text-gray-700">{{ item.item_name }}</span>
                                    {% if item.sugar or item.ice %}
                                    <span class="text-gray-400 text-xs">({{ item.sugar }}{% if item.sugar and item.ice %}/{% endif %}{{ item.ice }})</span>
                                    {% endif %}
                                </div>
                                <div class="flex items-center gap-2 flex-shrink-0">
                                    <span class="text-gray-400">Ã—{{ item.quantity }}</span>
                                    <button hx-post="/groups/{{ group.id }}/orders/follow/{{ item.id }}"
                                            hx-target="#my-order"
                                            hx-swap="innerHTML"
                                            hx-on::after-request="
                                                this.dispatchEvent(new CustomEvent('orderUpdated', {bubbles: true}));
                                                this.textContent = 'âœ“';
                                                this.disabled = true;
                                                this.classList.remove('bg-orange-500', 'hover:bg-orange-600');
                                                this.classList.add('bg-gray-300');
                                                if (window.Alpine) {
                                                    const comp = Alpine.$data(document.querySelector('[x-data]'));
                                                    if (comp) {
                                                        comp.orderStatus = 'draft';
                                                        comp.updateCartCount();
                                                    }
                                                }
                                            "
                                            class="text-xs text-white bg-orange-500 hover:bg-orange-600 px-2 py-1 rounded transition">
                                        è·Ÿå–®
                                    </button>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
                
                <p class="text-xs text-gray-400 text-center mt-4">é» +1 ç›´æ¥åŠ å…¥è³¼ç‰©è»Š</p>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- ä¸Šæ¬¡è¨‚å–® Modal -->
    {% if last_order and last_order_items %}
    <div x-show="showLastOrder" x-cloak
         class="fixed inset-0 z-50 flex items-center justify-center bg-black/50"
         @click.self="showLastOrder = false">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm mx-4">
            <div class="p-4 border-b">
                <h3 class="font-semibold text-gray-800">ğŸ“‹ ä¸Šæ¬¡åœ¨ {{ store.name }} çš„è¨‚å–®</h3>
                <p class="text-xs text-gray-400 mt-1">{{ last_order.created_at.strftime('%Y/%m/%d') }}</p>
            </div>
            
            <div class="p-4 max-h-60 overflow-y-auto">
                <div class="space-y-2">
                    {% for item in last_order_items %}
                    <div class="flex justify-between items-center text-sm bg-gray-50 rounded p-2">
                        <div>
                            <div class="font-medium">{{ item.item_name }}</div>
                            {% if item.sugar or item.ice %}
                            <div class="text-xs text-gray-500">{{ item.sugar }} / {{ item.ice }}</div>
                            {% endif %}
                            {% if item.note %}
                            <div class="text-xs text-gray-400">{{ item.note }}</div>
                            {% endif %}
                        </div>
                        <div class="text-right">
                            <div class="text-orange-600">${{ item.price }}</div>
                            <div class="text-xs text-gray-400">x{{ item.quantity }}</div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            
            <div class="p-4 border-t bg-gray-50 rounded-b-lg flex gap-2">
                <button @click="showLastOrder = false"
                        class="flex-1 py-2 rounded-lg border hover:bg-gray-100 text-sm">
                    å–æ¶ˆ
                </button>
                <form action="/groups/{{ group.id }}/orders/copy-last" method="post" class="flex-1">
                    <button type="submit"
                            class="w-full py-2 rounded-lg bg-blue-500 hover:bg-blue-600 text-white text-sm">
                        è¤‡è£½åˆ°è³¼ç‰©è»Š
                    </button>
                </form>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- éš¨æ©Ÿé¸æ“‡å™¨ Modal -->
    <div x-show="showRandom" x-cloak
         class="fixed inset-0 z-50 flex items-center justify-center bg-black/50"
         @click.self="showRandom = false">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm mx-4 text-center">
            <div class="p-6">
                <div class="text-5xl mb-4">ğŸ²</div>
                <template x-if="randomResult">
                    <div>
                        <div class="text-xl font-bold text-gray-800 mb-1" x-text="randomResult.name"></div>
                        <div class="text-orange-600 text-lg mb-4">$<span x-text="randomResult.price"></span></div>
                    </div>
                </template>
            </div>
            
            <div class="p-4 border-t bg-gray-50 rounded-b-lg flex gap-2">
                <button @click="randomPick()"
                        class="flex-1 py-2 rounded-lg border hover:bg-gray-100 text-sm">
                    ğŸ”„ å†æŠ½ä¸€æ¬¡
                </button>
                <button @click="goToRandomItem()"
                        class="flex-1 py-2 rounded-lg bg-orange-500 hover:bg-orange-600 text-white text-sm">
                    å»é»é€™å€‹ï¼
                </button>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- èœå–® -->
    {% if is_open %}
    <div class="bg-white rounded-lg shadow-sm p-4 pb-24" x-data="menuNav()">
        <h2 class="font-semibold text-gray-800 mb-3">èœå–®</h2>
        
        <!-- åˆ†é¡å¿«é€Ÿå°è¦½ï¼ˆå›ºå®šåœ¨é ‚éƒ¨ï¼‰ -->
        {% if menu.categories|length > 1 %}
        <div class="sticky top-12 bg-white py-2 -mx-4 px-4 border-b z-10 overflow-x-auto">
            <div class="flex gap-2 min-w-max">
                {% for category in menu.categories %}
                <button @click="scrollToCategory('category-{{ category.id }}')"
                        :class="activeCategory === 'category-{{ category.id }}' ? 'bg-orange-500 text-white border-orange-500' : 'border-orange-200 text-orange-600 hover:bg-orange-50'"
                        class="text-xs px-3 py-1.5 rounded-full border transition whitespace-nowrap">
                    {{ category.name }}
                </button>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        
        {% for category in menu.categories %}
        <div id="category-{{ category.id }}" class="mb-4 scroll-mt-28 category-section">
            <h3 class="text-sm font-medium text-gray-600 mb-2 pt-2">{{ category.name }}</h3>
            <div class="space-y-2">
                {% for item in category.items %}
                {% include "partials/menu_item.html" %}
                {% endfor %}
            </div>
        </div>
        {% endfor %}
        
        {% set uncategorized = menu.items | selectattr('category_id', 'none') | list %}
        {% if uncategorized %}
        <div class="space-y-2">
            {% for item in uncategorized %}
            {% include "partials/menu_item.html" %}
            {% endfor %}
        </div>
        {% endif %}
    </div>
    
    <!-- æ‡¸æµ®æŒ‰éˆ•å€åŸŸ -->
    <div class="fixed bottom-4 right-4 z-40 flex flex-col gap-2">
        <!-- è¿”å›é ‚ç«¯æŒ‰éˆ• -->
        <button @click="window.scrollTo({top: 0, behavior: 'smooth'})"
                x-data="{ showTop: false }"
                x-init="window.addEventListener('scroll', () => showTop = window.scrollY > 300)"
                x-show="showTop"
                x-transition
                class="bg-gray-500 hover:bg-gray-600 text-white rounded-full w-12 h-12 shadow-lg flex items-center justify-center">
            <span class="text-lg">â†‘</span>
        </button>
        
        <!-- è³¼ç‰©è»ŠæŒ‰éˆ•ï¼ˆåªæœ‰æœªçµå–®æ™‚é¡¯ç¤ºï¼‰ -->
        <button @click="showCart = true"
                x-show="orderStatus !== 'submitted'"
                class="bg-orange-500 hover:bg-orange-600 text-white rounded-full w-14 h-14 shadow-lg flex items-center justify-center relative">
            <span class="text-xl">ğŸ›’</span>
            <span x-show="cartCount > 0"
                  class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center"
                  x-text="cartCount"></span>
        </button>
    </div>
    
    <!-- è³¼ç‰©è»Šå´æ¬„ï¼ˆåªæœ‰æœªçµå–®æ™‚ä½¿ç”¨ï¼‰ -->
    <div x-show="showCart" x-cloak class="fixed inset-0 z-50">
        <div class="absolute inset-0 bg-black/30" @click="showCart = false"></div>
        <div class="absolute right-0 top-0 bottom-0 w-80 max-w-full bg-white shadow-xl flex flex-col"
             x-transition:enter="transition ease-out duration-200"
             x-transition:enter-start="translate-x-full"
             x-transition:enter-end="translate-x-0"
             x-transition:leave="transition ease-in duration-200"
             x-transition:leave-start="translate-x-0"
             x-transition:leave-end="translate-x-full">
            
            <!-- è³¼ç‰©è»Šæ¨™é¡Œ -->
            <div class="p-4 border-b flex items-center justify-between bg-orange-500 text-white">
                <h3 class="font-semibold text-lg">è³¼ç‰©è»Š</h3>
                <button @click="showCart = false" class="text-white/80 hover:text-white text-2xl">&times;</button>
            </div>
            
            <!-- è³¼ç‰©è»Šå…§å®¹ -->
            <div class="flex-1 overflow-y-auto" id="cart-content"
                 hx-get="/groups/{{ group.id }}/orders/mine" 
                 hx-trigger="load, orderUpdated from:body"
                 hx-swap="innerHTML">
                {% include "partials/my_order.html" %}
            </div>
            
            <!-- è³¼ç‰©è»Šåº•éƒ¨ -->
            <div class="p-4 border-t bg-gray-50">
                <div class="flex gap-2">
                    <button @click="showCart = false" 
                            class="flex-1 py-2.5 rounded-lg border hover:bg-gray-100 font-medium">
                        {% if group.category.value == 'group_buy' %}ç¹¼çºŒä¸‹å–®{% else %}ç¹¼çºŒé»é¤{% endif %}
                    </button>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- QR Code Modal -->
    <div x-show="showQR" x-cloak
         class="fixed inset-0 bg-black/50 flex items-center justify-center z-50"
         @click.self="showQR = false">
        <div class="bg-white rounded-lg p-6 mx-4 max-w-sm w-full text-center">
            <h3 class="font-semibold mb-4">æƒç¢¼åŠ å…¥åœ˜è³¼</h3>
            <div hx-get="/groups/{{ group.id }}/qrcode" hx-trigger="load" class="flex justify-center">
                <div class="animate-pulse bg-gray-200 w-48 h-48"></div>
            </div>
            <button @click="showQR = false" class="mt-4 text-gray-500 hover:text-gray-700">é—œé–‰</button>
        </div>
    </div>

    <!-- åŠ å…¥å“é … Modal -->
    <div x-show="showAddItem" x-cloak
         class="fixed inset-0 bg-black/50 flex items-end sm:items-center justify-center z-50"
         @click.self="showAddItem = false">
        <div class="bg-white rounded-t-2xl sm:rounded-lg p-6 w-full max-w-lg max-h-[85vh] overflow-y-auto">
            <h3 class="font-semibold text-lg mb-4" x-text="selectedItem?.name"></h3>
            
            <form hx-post="/groups/{{ group.id }}/orders/items" 
                  hx-target="#cart-content"
                  hx-swap="innerHTML"
                  @htmx:after-request="afterAddItem()">
                
                <input type="hidden" name="menu_item_id" :value="selectedItem?.id">
                
                <!-- å°ºå¯¸é¸æ“‡ -->
                <div x-show="selectedItem?.price_l" class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">å°ºå¯¸</label>
                    <div class="flex gap-2">
                        <label class="cursor-pointer flex-1">
                            <input type="radio" name="size" value="M" x-model="selectedSize" class="peer hidden" checked>
                            <span class="block px-3 py-2 rounded border text-center peer-checked:bg-orange-500 peer-checked:text-white peer-checked:border-orange-500">
                                M <span x-text="'$' + selectedItem?.price"></span>
                            </span>
                        </label>
                        <label class="cursor-pointer flex-1">
                            <input type="radio" name="size" value="L" x-model="selectedSize" class="peer hidden">
                            <span class="block px-3 py-2 rounded border text-center peer-checked:bg-orange-500 peer-checked:text-white peer-checked:border-orange-500">
                                L <span x-text="'$' + selectedItem?.price_l"></span>
                            </span>
                        </label>
                    </div>
                </div>
                
                <!-- ç”œåº¦ -->
                {% if group.category.value == 'drink' %}
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">ç”œåº¦</label>
                    {% if group.lock_sugar %}
                    <div class="text-gray-600">{{ group.default_sugar }} (å·²é–å®š)</div>
                    <input type="hidden" name="sugar" value="{{ group.default_sugar }}">
                    {% else %}
                    <div class="flex flex-wrap gap-2">
                        {% for opt in store.options if opt.option_type.value == 'sugar' %}
                        <label class="cursor-pointer">
                            <input type="radio" name="sugar" value="{{ opt.option_value }}" 
                                   class="peer hidden" {% if opt.option_value == group.default_sugar %}checked{% endif %}>
                            <span class="block px-3 py-1.5 rounded border peer-checked:bg-orange-500 peer-checked:text-white peer-checked:border-orange-500">
                                {{ opt.option_value }}
                            </span>
                        </label>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
                
                <!-- å†°å¡Š -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">å†°å¡Š</label>
                    {% if group.lock_ice %}
                    <div class="text-gray-600">{{ group.default_ice }} (å·²é–å®š)</div>
                    <input type="hidden" name="ice" value="{{ group.default_ice }}">
                    {% else %}
                    <div class="flex flex-wrap gap-2">
                        {% for opt in store.options if opt.option_type.value == 'ice' %}
                        <label class="cursor-pointer">
                            <input type="radio" name="ice" value="{{ opt.option_value }}" 
                                   class="peer hidden" {% if opt.option_value == group.default_ice %}checked{% endif %}>
                            <span class="block px-3 py-1.5 rounded border peer-checked:bg-orange-500 peer-checked:text-white peer-checked:border-orange-500">
                                {{ opt.option_value }}
                            </span>
                        </label>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
                
                <!-- åŠ æ–™é¸é …ï¼ˆé£²æ–™åº—ï¼‰ -->
                {% if store.toppings %}
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">åŠ æ–™</label>
                    <div class="flex flex-wrap gap-2">
                        {% for topping in store.toppings if topping.is_active %}
                        <label class="cursor-pointer">
                            <input type="checkbox" name="toppings" value="{{ topping.id }}" class="peer hidden">
                            <span class="block px-3 py-1.5 rounded border peer-checked:bg-orange-500 peer-checked:text-white peer-checked:border-orange-500">
                                {{ topping.name }} {% if topping.price > 0 %}+${{ topping.price|int }}{% endif %}
                            </span>
                        </label>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                {% endif %}
                
                <!-- åŠ è³¼é¸é … -->
                <div x-show="selectedItem?.options?.length > 0" class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">åŠ è³¼é¸é …</label>
                    <div class="space-y-2" x-html="renderOptions()"></div>
                </div>
                
                <!-- æ•¸é‡ -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">æ•¸é‡</label>
                    <div class="flex items-center gap-3">
                        <button type="button" @click="quantity = Math.max(1, quantity - 1)"
                                class="w-10 h-10 rounded-full bg-gray-100 hover:bg-gray-200 text-xl">âˆ’</button>
                        <input type="number" name="quantity" x-model="quantity" min="1" 
                               class="w-16 text-center border rounded py-2">
                        <button type="button" @click="quantity++"
                                class="w-10 h-10 rounded-full bg-gray-100 hover:bg-gray-200 text-xl">+</button>
                    </div>
                </div>
                
                <!-- å‚™è¨» -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">å‚™è¨»</label>
                    <input type="text" name="note" placeholder="ç‰¹æ®Šéœ€æ±‚..." 
                           class="w-full border rounded px-3 py-2">
                </div>
                
                <!-- æŒ‰éˆ• -->
                <div class="flex gap-2">
                    <button type="button" @click="showAddItem = false"
                            class="flex-1 py-3 rounded-lg border hover:bg-gray-50">
                        å–æ¶ˆ
                    </button>
                    <button type="submit"
                            class="flex-1 py-3 rounded-lg bg-orange-500 hover:bg-orange-600 text-white font-medium">
                        åŠ å…¥è³¼ç‰©è»Š
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function orderPage() {
    // èœå–®å“é …åˆ—è¡¨ï¼ˆç”¨æ–¼éš¨æ©Ÿé¸æ“‡ï¼‰
    const menuItems = [
        {% for category in menu.categories %}
        {% for item in category.items %}
        { id: {{ item.id }}, name: "{{ item.name }}", price: {{ item.price }} },
        {% endfor %}
        {% endfor %}
        {% set uncategorized = menu.items | selectattr('category_id', 'none') | list %}
        {% for item in uncategorized %}
        { id: {{ item.id }}, name: "{{ item.name }}", price: {{ item.price }} },
        {% endfor %}
    ];
    
    return {
        showQR: false,
        showAddItem: false,
        showCart: false,
        showSettings: false,
        showReminder: false,
        showLastOrder: false,
        showOthersOrders: false,
        selectedItem: null,
        selectedSize: 'M',
        quantity: 1,
        cartCount: {{ (my_order.items|length if my_order and my_order.status.value != 'submitted' else 0) }},
        orderStatus: '{{ my_order.status.value if my_order else "none" }}',
        showRandom: false,
        randomResult: null,
        
        randomPick() {
            if (menuItems.length === 0) {
                alert('èœå–®æ˜¯ç©ºçš„ï¼');
                return;
            }
            const item = menuItems[Math.floor(Math.random() * menuItems.length)];
            this.randomResult = item;
            this.showRandom = true;
        },
        
        goToRandomItem() {
            if (this.randomResult) {
                scrollToItem(this.randomResult.id);
                this.showRandom = false;
            }
        },
        
        async openAddItem(item) {
            // å¦‚æœå·²çµå–®ï¼Œå…ˆå•æ˜¯å¦è¦åŠ é»
            if (this.orderStatus === 'submitted') {
                if (!confirm('æ‚¨å·²çµå–®ï¼Œæ˜¯å¦è¦åŠ é»ï¼Ÿ\n\né¸ã€Œç¢ºå®šã€å°‡ä¿®æ”¹è¨‚å–®ä¸¦åŠ é»\né¸ã€Œå–æ¶ˆã€å‰‡ä¸åŠ é»')) {
                    return;
                }
                // å…ˆèª¿ç”¨ä¿®æ”¹è¨‚å–® API
                await fetch('/groups/{{ group.id }}/orders/edit', { method: 'POST' });
                this.orderStatus = 'editing';
                document.body.dispatchEvent(new CustomEvent('orderUpdated'));
            }
            
            this.selectedItem = item;
            this.selectedSize = 'M';
            this.quantity = 1;
            this.showAddItem = true;
        },
        
        afterAddItem() {
            this.showAddItem = false;
            this.updateCartCount();
            this.orderStatus = 'draft';
            document.body.dispatchEvent(new CustomEvent('orderUpdated'));
        },
        
        updateCartCount() {
            setTimeout(() => {
                const items = document.querySelectorAll('#cart-content [data-item-id]');
                this.cartCount = items.length;
            }, 100);
        },
        
        copyLink() {
            navigator.clipboard.writeText(window.location.href);
            alert('é€£çµå·²è¤‡è£½ï¼');
        },
        
        renderOptions() {
            if (!this.selectedItem?.options) return '';
            return this.selectedItem.options.map(opt => `
                <label class="flex items-center gap-2 cursor-pointer">
                    <input type="checkbox" name="options" value="${opt.id}" class="rounded">
                    <span>${opt.name}</span>
                    ${opt.price_diff > 0 ? `<span class="text-gray-500">+$${opt.price_diff}</span>` : ''}
                </label>
            `).join('');
        }
    }
}

function countdown(deadline) {
    return {
        display: '',
        init() {
            this.update();
            setInterval(() => this.update(), 1000);
        },
        update() {
            const now = new Date();
            const end = new Date(deadline);
            const diff = end - now;
            
            if (diff <= 0) {
                this.display = 'å·²æˆªæ­¢';
                return;
            }
            
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            
            if (hours > 0) {
                this.display = `â° ${hours}h ${minutes}m`;
            } else {
                const seconds = Math.floor((diff % (1000 * 60)) / 1000);
                this.display = `â° ${minutes}m ${seconds}s`;
            }
        }
    }
}

// ç›£è¯è¨‚å–®æ›´æ–°äº‹ä»¶
document.body.addEventListener('orderUpdated', function() {
    setTimeout(() => {
        const items = document.querySelectorAll('#cart-content [data-item-id]');
        const countEl = document.querySelector('[x-text="cartCount"]');
        if (countEl) {
            countEl.textContent = items.length;
        }
    }, 100);
});

// æ»¾å‹•åˆ°æŒ‡å®šå“é …
function scrollToItem(itemId) {
    const el = document.querySelector(`[data-menu-item-id="${itemId}"]`);
    if (el) {
        el.scrollIntoView({ behavior: 'smooth', block: 'center' });
        // é–ƒçˆæ•ˆæœ
        el.classList.add('ring-2', 'ring-orange-400');
        setTimeout(() => {
            el.classList.remove('ring-2', 'ring-orange-400');
        }, 2000);
    }
}

// èœå–®åˆ†é¡å°è¦½
function menuNav() {
    return {
        activeCategory: '',
        init() {
            // ç›£è½æ»¾å‹•äº‹ä»¶
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        this.activeCategory = entry.target.id;
                    }
                });
            }, {
                rootMargin: '-100px 0px -70% 0px',
                threshold: 0
            });
            
            // è§€å¯Ÿæ‰€æœ‰åˆ†é¡å€å¡Š
            document.querySelectorAll('.category-section').forEach(section => {
                observer.observe(section);
            });
            
            // è¨­å®šåˆå§‹åˆ†é¡
            const firstCategory = document.querySelector('.category-section');
            if (firstCategory) {
                this.activeCategory = firstCategory.id;
            }
        },
        scrollToCategory(id) {
            const el = document.getElementById(id);
            if (el) {
                el.scrollIntoView({ behavior: 'smooth', block: 'start' });
                this.activeCategory = id;
            }
        }
    }
}

// æ”¶è—åº—å®¶åˆ‡æ›
async function toggleFavorite(storeId) {
    try {
        const response = await fetch(`/favorites/${storeId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        const data = await response.json();
        
        const btn = document.getElementById('fav-btn');
        const text = document.getElementById('fav-text');
        if (data.status === 'added') {
            btn.querySelector('span:first-child').textContent = 'â­';
            btn.title = 'å–æ¶ˆæ”¶è—';
            if (text) text.textContent = 'å·²æ”¶è—';
        } else {
            btn.querySelector('span:first-child').textContent = 'â˜†';
            btn.title = 'æ”¶è—åº—å®¶';
            if (text) text.textContent = 'æ”¶è—';
        }
    } catch (err) {
        console.error('Toggle favorite failed:', err);
    }
}
</script>
{% endblock %}
